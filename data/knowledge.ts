// 치과 용어 및 규칙 (knowledge_db.md 기반)

// 용어 치환 규칙
export const TERM_REPLACEMENTS: Record<string, string> = {
  // 보철 관련
  '크라운': '지르코니아 보철',
  '금니': '금 보철',
  '이빨': '치아',
  '때운다': '수복한다',
  '때움': '수복',
  '씌운다': '보철을 장착한다',
  '빼다': '발치하다',
  // 임플란트 관련
  '심는다': '식립한다',
  '뼈이식': '골이식',
  '잇몸뼈': '치조골',
  '평생 사용': '장기간 사용 가능',
  '반영구적': '오래 사용 가능',
  // 교정 관련
  '철사': '교정용 와이어',
  '고무줄': '교정용 엘라스틱',
  '덧니': '총생',
  '뻐드렁니': '돌출입',
  // 일반 치료
  '썩은 이': '충치',
  '신경 죽이기': '신경치료',
}

// 절대 금지어 (의료광고법 위반)
export const FORBIDDEN_WORDS = [
  '최고', '최첨단', '최신', '유일', '독보적',
  '완치', '100%', '무통', '무조건',
  '전문화', '특화', '명의', '실력파',
  '저렴한', '싼', '할인', '이벤트',
  '후기', '체험담', '환자 인터뷰',
  '평생', '반영구',
]

// 치료별 의학적 팩트 (확장된 버전)
export const MEDICAL_FACTS = {
  임플란트: {
    duration: '일반적으로 3~6개월 (골이식 시 추가 소요)',
    lifespan: '관리에 따라 다름 (10년 이상 가능하나 보장 불가)',
    caution: '정기 검진 필수, 흡연 시 실패율 증가',
  },
  지르코니아보철: {
    material: '심미성 우수, 자연치와 유사한 색상 구현',
    strength: '금속 보철 대비 심미성 우수, 강도 충분',
    lifespan: '관리에 따라 상이',
  },
  신경치료: {
    purpose: '치아 내부 감염 조직 제거 후 보존',
    visits: '일반적으로 2~3회 내원',
    aftercare: '보철(크라운) 씌워 보호 권장',
  },
  교정치료: {
    duration: '케이스에 따라 1년~3년',
    retainer: '교정 후 착용 필수',
    types: '메탈, 세라믹, 투명교정 등',
  },
  충치치료: {
    stages: '레진 수복 → 인레이 → 크라운 → 신경치료 순',
    importance: '조기 발견 중요성 강조',
  },
}

// ============================================================
// 확장된 의학 정보 데이터베이스 (신뢰할 수 있는 의학 정보)
// 출처: 대한치과의사협회, 대한치주과학회, 대한구강악안면외과학회 등
// ============================================================

export interface MedicalInfo {
  definition: string           // 정확한 의학적 정의
  causes: string[]            // 원인들
  symptoms: string[]          // 증상들
  treatmentProcess: string[]  // 치료 과정 (단계별)
  duration: string            // 치료 기간
  aftercare: string[]         // 치료 후 관리
  precautions: string[]       // 주의사항
  faq: Array<{ q: string; a: string }> // 자주 묻는 질문
  statistics?: string         // 통계 (있는 경우)
}

export const DETAILED_MEDICAL_INFO: Record<string, MedicalInfo> = {
  임플란트: {
    definition: '임플란트는 상실된 치아를 대체하기 위해 치조골에 티타늄 재질의 인공 치근을 식립하고, 그 위에 인공 치관을 연결하는 치료법입니다.',
    causes: [
      '충치나 치주질환으로 인한 치아 상실',
      '외상으로 인한 치아 손실',
      '선천적 치아 결손',
      '치아 파절로 인한 발치',
    ],
    symptoms: [
      '치아가 빠진 부위의 씹기 불편함',
      '인접 치아의 이동',
      '반대편 치아의 정출',
      '저작 기능 저하',
    ],
    treatmentProcess: [
      '1단계: 정밀 검사 및 치료 계획 수립 (CT 촬영, 구강 검진)',
      '2단계: 필요시 골이식 시술 (치조골이 부족한 경우)',
      '3단계: 임플란트 픽스쳐(인공 치근) 식립 수술',
      '4단계: 골유착 기간 (보통 3~6개월)',
      '5단계: 지대주(어버트먼트) 연결',
      '6단계: 최종 보철물(크라운) 장착',
    ],
    duration: '전체 과정 3~6개월 (골이식 필요시 6개월 이상)',
    aftercare: [
      '수술 당일 냉찜질로 부기 완화',
      '부드러운 음식 섭취 (수술 후 1~2주)',
      '격렬한 운동 자제 (1~2주)',
      '금연 권장 (흡연 시 골유착 실패율 증가)',
      '6개월마다 정기 검진',
    ],
    precautions: [
      '당뇨, 고혈압 등 전신질환이 있는 경우 사전 상담 필요',
      '골다공증 약물 복용 중인 경우 반드시 고지',
      '출혈 경향이 있는 약물 복용 시 사전 조절',
      '흡연자의 경우 실패 확률이 높아질 수 있음',
    ],
    faq: [
      { q: '임플란트 수술이 아픈가요?', a: '국소마취 하에 진행되어 수술 중 통증은 거의 없습니다. 수술 후에는 처방된 진통제로 관리 가능합니다.' },
      { q: '임플란트 수명은 얼마나 되나요?', a: '적절한 관리 시 10년 이상 사용 가능하며, 정기 검진과 구강 위생 관리가 중요합니다.' },
      { q: '임플란트 비용은 어떻게 되나요?', a: '개인의 구강 상태와 골이식 필요 여부에 따라 달라지며, 정확한 비용은 상담 후 안내됩니다.' },
    ],
    statistics: '국내 임플란트 시술 성공률은 약 95~98% 수준으로 보고되고 있습니다.',
  },

  신경치료: {
    definition: '신경치료(근관치료)는 치아 내부의 치수(신경과 혈관이 있는 조직)가 감염되거나 괴사되었을 때, 이를 제거하고 소독한 뒤 특수 재료로 충전하는 치료입니다.',
    causes: [
      '깊은 충치로 인한 치수 감염',
      '치아 외상으로 인한 치수 손상',
      '치아 파절',
      '반복적인 치과 시술로 인한 치수 손상',
      '치주질환으로 인한 역행성 감염',
    ],
    symptoms: [
      '지속적인 치아 통증',
      '차갑거나 뜨거운 것에 예민한 반응',
      '씹을 때 통증',
      '잇몸 부종이나 뾰루지',
      '치아 변색',
    ],
    treatmentProcess: [
      '1단계: X-ray 촬영으로 감염 범위 확인',
      '2단계: 국소마취 후 치아 상부 개방',
      '3단계: 감염된 치수 조직 제거',
      '4단계: 근관(신경관) 성형 및 소독',
      '5단계: 근관 충전 (가타퍼차로 밀봉)',
      '6단계: 치아 보강 후 최종 수복물(크라운) 장착',
    ],
    duration: '일반적으로 2~3회 내원 (1~2주 간격)',
    aftercare: [
      '치료 완료 후 크라운 수복 권장 (치아 파절 예방)',
      '일시적인 불편감은 진통제로 관리',
      '딱딱한 음식 자제 (최종 수복 전까지)',
      '정기 검진으로 예후 확인',
    ],
    precautions: [
      '치료 중간에 중단하면 재감염 위험',
      '신경치료 후 크라운을 하지 않으면 치아 파절 위험 증가',
      '치료 후에도 통증이 지속되면 재내원 필요',
    ],
    faq: [
      { q: '신경치료는 왜 여러 번 내원해야 하나요?', a: '근관 내부를 충분히 소독하고 완전히 건조시키기 위해 시간이 필요합니다. 철저한 소독이 재발 방지에 중요합니다.' },
      { q: '신경치료 후 치아가 약해지나요?', a: '치수가 제거되면 치아에 영양 공급이 안 되어 다소 약해질 수 있습니다. 그래서 크라운으로 보호하는 것을 권장합니다.' },
      { q: '신경치료가 실패할 수도 있나요?', a: '일부 경우 재치료가 필요할 수 있으며, 치근단 수술이나 발치를 고려하기도 합니다.' },
    ],
    statistics: '신경치료 성공률은 약 90~95%로 보고됩니다.',
  },

  사랑니: {
    definition: '사랑니(제3대구치)는 보통 17~25세 사이에 맹출하는 가장 마지막 어금니로, 맹출 공간이 부족하여 매복되거나 비정상적으로 자라는 경우가 많습니다.',
    causes: [
      '턱뼈 공간 부족으로 인한 매복',
      '비정상적인 맹출 방향 (수평매복, 경사매복 등)',
      '인접 치아에 대한 압박',
    ],
    symptoms: [
      '잇몸 부종 및 통증',
      '입을 벌리기 어려움 (개구장애)',
      '인접 치아 통증',
      '두통이나 귀 주변 통증',
      '음식물 저류로 인한 충치나 염증',
    ],
    treatmentProcess: [
      '1단계: 파노라마 또는 CT 촬영으로 사랑니 위치 확인',
      '2단계: 발치 난이도 평가 (단순/복잡/매복)',
      '3단계: 국소마취 또는 진정마취 시행',
      '4단계: 필요시 잇몸 절개 및 치조골 삭제',
      '5단계: 사랑니 분할 발치 (필요시)',
      '6단계: 봉합 및 지혈',
    ],
    duration: '단순 발치 10~20분, 매복 발치 30~60분',
    aftercare: [
      '거즈 물고 30분~1시간 지혈',
      '발치 당일 냉찜질, 다음날부터 온찜질',
      '부드러운 음식 섭취 (2~3일)',
      '발치 부위 빨대 사용 금지 (드라이소켓 예방)',
      '격렬한 양치질 자제',
      '금연 및 음주 자제 (1주일)',
    ],
    precautions: [
      '하치조신경 손상 가능성 (일시적/영구적 감각 이상)',
      '드라이소켓 발생 시 심한 통증 (발치 후 2~4일)',
      '출혈이 지속되면 즉시 내원',
      '발열이나 심한 부종 시 감염 의심',
    ],
    faq: [
      { q: '사랑니는 꼭 빼야 하나요?', a: '정상적으로 맹출하고 관리가 잘 되면 보존 가능합니다. 하지만 문제가 예상되거나 증상이 있으면 발치를 권합니다.' },
      { q: '4개 사랑니를 한 번에 발치할 수 있나요?', a: '가능하지만, 보통 한쪽(상하) 2개씩 나눠서 발치하는 것을 권장합니다.' },
      { q: '발치 후 붓기는 언제 빠지나요?', a: '보통 2~3일째 가장 심하고, 1주일 정도면 대부분 빠집니다.' },
    ],
  },

  충치: {
    definition: '충치(치아우식증)는 구강 내 세균이 음식물의 당분을 분해하여 산을 생성하고, 이 산이 치아의 법랑질과 상아질을 파괴하는 질환입니다.',
    causes: [
      '당분이 많은 음식 섭취',
      '불량한 구강 위생',
      '타액 분비 감소',
      '치아 형태상 음식물이 끼기 쉬운 구조',
      '치아 맹출 후 불소 노출 부족',
    ],
    symptoms: [
      '초기: 자각 증상 없음 (정기 검진으로 발견)',
      '중기: 차갑거나 달콤한 음식에 시린 증상',
      '후기: 지속적인 통증, 씹을 때 통증',
      '말기: 치수 감염 시 자발통, 박동성 통증',
    ],
    treatmentProcess: [
      '1단계 (초기 충치): 불소 도포로 재광화 유도',
      '2단계 (법랑질 충치): 레진 수복',
      '3단계 (상아질 충치): 레진 또는 인레이 수복',
      '4단계 (치수 인접): 간접치수복조술 후 수복',
      '5단계 (치수 노출): 신경치료 후 크라운',
    ],
    duration: '단순 레진 수복 30분~1시간, 인레이/크라운은 2회 내원',
    aftercare: [
      '당분 섭취 제한',
      '식후 양치질 습관화',
      '치실 또는 치간칫솔 사용',
      '6개월마다 정기 검진',
      '불소 치약 사용',
    ],
    precautions: [
      '충치는 자연치유되지 않음 - 조기 치료가 중요',
      '수복물 주변 이차 충치 주의',
      '정기 검진으로 조기 발견 중요',
    ],
    faq: [
      { q: '충치가 아프지 않은데 치료해야 하나요?', a: '충치 초기에는 통증이 없습니다. 통증이 생기면 이미 진행된 상태이므로 조기 치료가 중요합니다.' },
      { q: '충치 치료 후 다시 충치가 생길 수 있나요?', a: '수복물 주변이나 다른 치아에 이차 충치가 생길 수 있어 관리가 필요합니다.' },
    ],
    statistics: '대한민국 성인의 약 90% 이상이 충치 경험이 있습니다.',
  },

  교정: {
    definition: '치아 교정은 배열이 고르지 않거나 부정교합이 있는 치아와 턱뼈를 바른 위치로 이동시켜 기능과 심미성을 개선하는 치료입니다.',
    causes: [
      '유전적 요인',
      '어린 시절 잘못된 습관 (손가락 빨기, 구호흡 등)',
      '조기 유치 상실',
      '치아 크기와 턱뼈 크기 불균형',
    ],
    symptoms: [
      '덧니, 삐뚤빼뚤한 치열',
      '돌출입, 무턱',
      '앞니 물림 불량 (개방교합, 과개교합)',
      '비대칭',
      '씹는 기능 저하',
    ],
    treatmentProcess: [
      '1단계: 정밀 진단 (X-ray, 모형 분석, 안면 사진)',
      '2단계: 치료 계획 수립',
      '3단계: 필요시 발치 (공간 확보용)',
      '4단계: 교정 장치 장착 (브라켓 또는 투명교정)',
      '5단계: 정기 내원하여 장치 조절 (4~6주 간격)',
      '6단계: 교정 완료 후 유지장치 착용',
    ],
    duration: '일반적으로 1년 6개월~3년 (케이스에 따라 다름)',
    aftercare: [
      '유지장치(리테이너) 착용 필수',
      '철사 교정 시 양치질에 주의',
      '정기 내원 빠짐없이 방문',
      '딱딱하거나 끈적한 음식 자제',
    ],
    precautions: [
      '유지장치 미착용 시 재발 가능',
      '치아 우식이나 잇몸 질환 주의',
      '치근 흡수 가능성',
      '턱관절 불편감 가능',
    ],
    faq: [
      { q: '교정은 몇 살에 하는 게 좋나요?', a: '영구치 맹출 후 청소년기가 적기이지만, 성인 교정도 가능합니다.' },
      { q: '투명교정과 철사 교정의 차이는?', a: '투명교정은 심미적이고 탈착 가능하지만, 복잡한 케이스는 철사 교정이 효과적입니다.' },
      { q: '교정 후 재발하면 어떻게 하나요?', a: '유지장치 착용으로 재발을 예방하며, 재발 시 재교정이 필요할 수 있습니다.' },
    ],
  },

  스케일링: {
    definition: '스케일링은 치아와 잇몸 경계부에 축적된 치석(치태가 석회화된 것)을 초음파 기구나 수기구로 제거하는 예방적 치료입니다.',
    causes: [
      '불충분한 양치질',
      '치실 사용 부재',
      '타액 성분 개인차',
      '흡연',
      '장기간 스케일링 미실시',
    ],
    symptoms: [
      '잇몸 출혈 (양치질 시)',
      '구취',
      '잇몸 부종 및 발적',
      '치아 표면의 거친 느낌',
    ],
    treatmentProcess: [
      '1단계: 치석 분포 확인',
      '2단계: 초음파 스케일러로 치석 제거',
      '3단계: 수기구로 세밀한 부위 마무리',
      '4단계: 치면 연마 (필요시)',
    ],
    duration: '30분~1시간 (치석 양에 따라 다름)',
    aftercare: [
      '시린 증상 1~2주 내 완화',
      '잇몸 출혈 점차 감소',
      '올바른 양치질 습관 유지',
      '6개월~1년마다 정기 스케일링 권장',
    ],
    precautions: [
      '스케일링 후 일시적 시린 증상은 정상',
      '잇몸 질환이 있으면 추가 치료 필요',
      '혈액 응고 장애 시 사전 상담',
    ],
    faq: [
      { q: '스케일링하면 치아 사이가 벌어지나요?', a: '치석이 차지하던 공간이 비어 벌어진 것처럼 느껴지지만, 실제 치아 간격은 변하지 않습니다.' },
      { q: '스케일링은 얼마나 자주 해야 하나요?', a: '일반적으로 6개월~1년에 한 번을 권장하며, 잇몸 상태에 따라 더 자주 필요할 수 있습니다.' },
    ],
    statistics: '만 19세 이상 성인은 연 1회 건강보험으로 스케일링이 가능합니다.',
  },

  보철: {
    definition: '보철치료는 손상되거나 상실된 치아를 인공 재료로 수복하여 기능과 심미성을 회복하는 치료로, 크라운, 브릿지, 틀니 등이 있습니다.',
    causes: [
      '충치로 인한 치아 구조 손상',
      '신경치료 후 치아 보호 필요',
      '치아 파절',
      '치아 상실 (발치 후)',
    ],
    symptoms: [
      '씹는 기능 저하',
      '치아 파절 위험',
      '심미성 저하',
      '인접 치아 이동',
    ],
    treatmentProcess: [
      '1단계: 치아 상태 평가 및 치료 계획',
      '2단계: 치아 삭제 및 형태 다듬기',
      '3단계: 인상 채득 (본뜨기)',
      '4단계: 임시 보철물 장착',
      '5단계: 기공 제작 (1~2주)',
      '6단계: 최종 보철물 장착 및 교합 조정',
    ],
    duration: '일반적으로 2~3주 (2~3회 내원)',
    aftercare: [
      '보철물 주변 꼼꼼히 양치질',
      '지나치게 딱딱한 음식 자제',
      '정기 검진으로 적합도 확인',
      '보철물 탈락 시 즉시 내원',
    ],
    precautions: [
      '보철물 하방 치아 우식 주의',
      '치실 사용으로 경계부 관리',
      '탈락 시 삼키지 않도록 주의',
    ],
    faq: [
      { q: '지르코니아와 금 보철의 차이는?', a: '지르코니아는 심미성이 우수하고, 금은 생체친화성과 내구성이 좋습니다. 부위와 상황에 따라 선택합니다.' },
      { q: '보철물 수명은 얼마나 되나요?', a: '관리에 따라 다르지만 일반적으로 7~15년 정도 사용 가능합니다.' },
    ],
  },

  잇몸치료: {
    definition: '잇몸치료(치주치료)는 치은염이나 치주염 등 잇몸 질환을 치료하여 치아 주변 조직의 건강을 회복시키는 치료입니다.',
    causes: [
      '치태와 치석 축적',
      '불량한 구강 위생',
      '흡연',
      '당뇨병 등 전신질환',
      '유전적 요인',
      '스트레스',
    ],
    symptoms: [
      '잇몸 출혈',
      '잇몸 부종 및 발적',
      '구취',
      '치아 흔들림',
      '잇몸 퇴축으로 치아가 길어 보임',
      '치아 사이 벌어짐',
    ],
    treatmentProcess: [
      '1단계: 치주 검사 (치주낭 깊이 측정)',
      '2단계: 스케일링 및 치근활택술',
      '3단계: 필요시 치주소파술 또는 치주 수술',
      '4단계: 유지치료 (정기 내원)',
    ],
    duration: '경증 2~4주, 중증 수개월',
    aftercare: [
      '철저한 구강 위생 관리',
      '정기적인 유지치료 (3~6개월 간격)',
      '금연',
      '당뇨 등 전신질환 관리',
    ],
    precautions: [
      '치주질환은 만성질환으로 완치 개념보다 관리 개념',
      '방치 시 치아 상실로 이어짐',
      '전신 건강에도 영향 (심혈관 질환 등)',
    ],
    faq: [
      { q: '잇몸병은 완치되나요?', a: '만성 질환으로 완치보다 관리가 중요합니다. 정기적인 치료와 관리로 진행을 멈출 수 있습니다.' },
      { q: '잇몸이 내려간 건 회복되나요?', a: '자연 회복은 어렵고, 심한 경우 잇몸 이식술이 필요할 수 있습니다.' },
    ],
  },
}

// 의학 정보 가져오기 함수
export function getMedicalInfo(topic: string): MedicalInfo | null {
  const topicLower = topic.toLowerCase()

  for (const [key, info] of Object.entries(DETAILED_MEDICAL_INFO)) {
    if (topicLower.includes(key.toLowerCase()) || key.includes(topic)) {
      return info
    }
  }

  return null
}

// 의학 정보를 프롬프트용 문자열로 변환
export function formatMedicalInfoForPrompt(topic: string): string {
  const info = getMedicalInfo(topic)
  if (!info) return ''

  return `
## 📚 ${topic} 관련 의학 정보 (신뢰할 수 있는 출처 기반)

### 정의
${info.definition}

### 주요 원인
${info.causes.map(c => `- ${c}`).join('\n')}

### 대표적인 증상
${info.symptoms.map(s => `- ${s}`).join('\n')}

### 치료 과정
${info.treatmentProcess.map(p => `${p}`).join('\n')}

### 치료 기간
${info.duration}

### 치료 후 관리
${info.aftercare.map(a => `- ${a}`).join('\n')}

### 주의사항
${info.precautions.map(p => `- ${p}`).join('\n')}

### 자주 묻는 질문 (FAQ)
${info.faq.map(f => `Q. ${f.q}\nA. ${f.a}`).join('\n\n')}

${info.statistics ? `### 참고 통계\n${info.statistics}` : ''}

---
⚠️ 위 정보를 참고하여 글을 작성하되, 의료광고법을 준수하세요.
`
}

// 전문용어 + 비유 표현 (전문용어 설명 후 비유로 이해 돕기)
// 패턴: "[전문용어]란 [정확한 설명]이에요. 쉽게 말해 [비유 표현]처럼요."
export const METAPHORS: Record<string, { term: string; definition: string; metaphor: string }> = {
  신경치료: {
    term: '근관치료(신경치료)',
    definition: '치아 내부의 신경과 혈관이 있는 치수 조직이 감염되었을 때, 이를 제거하고 소독한 뒤 특수 재료로 채우는 치료',
    metaphor: '썩은 과일의 속을 깨끗이 파내고 방부 처리를 하는 것',
  },
  임플란트: {
    term: '임플란트(인공치아)',
    definition: '상실된 치아 부위에 티타늄 재질의 인공 치근을 치조골에 식립한 후, 그 위에 보철물을 연결하는 치료',
    metaphor: '땅에 말뚝을 박고 그 위에 집을 짓는 것',
  },
  크라운: {
    term: '크라운(치관 보철)',
    definition: '손상되거나 약해진 치아 전체를 감싸서 보호하고 기능을 회복시키는 보철물',
    metaphor: '약해진 치아에 단단한 헬멧을 씌워주는 것',
  },
  치조골: {
    term: '치조골(잇몸뼈)',
    definition: '치아 뿌리를 둘러싸고 지지해주는 턱뼈의 일부',
    metaphor: '치아가 단단히 서 있을 수 있게 해주는 기초 땅',
  },
  골이식: {
    term: '골이식(뼈이식)',
    definition: '치조골이 부족할 때 자가골, 동종골, 이종골 또는 합성골을 이식해 뼈의 양을 증가시키는 시술',
    metaphor: '집을 짓기 전에 땅을 보강하는 기초 공사',
  },
  발치: {
    term: '발치(치아 제거)',
    definition: '손상되거나 치료가 불가능한 치아를 치조골에서 분리하여 제거하는 시술',
    metaphor: '뿌리 깊이 박힌 나무를 조심스럽게 뽑아내는 것',
  },
  스케일링: {
    term: '스케일링(치석 제거)',
    definition: '치아와 잇몸 사이에 쌓인 치태와 치석을 초음파 기구로 제거하는 예방 치료',
    metaphor: '오랫동안 쌓인 녹과 때를 깨끗이 벗겨내는 것',
  },
}

// 비유 표현 생성 함수 (프롬프트에서 사용)
export function getMetaphorText(topic: string): string {
  const metaphor = METAPHORS[topic]
  if (!metaphor) return ''

  return `"${metaphor.term}"이란 ${metaphor.definition}이에요. 쉽게 말해 ${metaphor.metaphor}과 비슷하다고 생각하시면 돼요.`
}

// 용어 치환 함수
export function replaceTerms(text: string): string {
  let result = text
  for (const [wrong, correct] of Object.entries(TERM_REPLACEMENTS)) {
    result = result.replace(new RegExp(wrong, 'g'), correct)
  }
  return result
}

// 금지어 검사 함수
export function checkForbiddenWords(text: string): string[] {
  return FORBIDDEN_WORDS.filter(word => text.includes(word))
}
