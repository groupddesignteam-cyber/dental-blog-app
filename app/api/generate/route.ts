import Anthropic from '@anthropic-ai/sdk'
import OpenAI from 'openai'
import { GoogleGenerativeAI } from '@google/generative-ai'
import { NextRequest } from 'next/server'
import { GenerateFormData, LLMModel, WritingMode, BatchDiversityHints } from '@/types'

// 데이터 파일들
import { TERM_REPLACEMENTS, formatMedicalInfoForPrompt } from '@/data/knowledge'
import { REQUIRED_DISCLAIMERS, getDisclaimer, checkForbiddenPatterns } from '@/data/medical-law'
import { CONTENT_RULES, generateHashtags } from '@/data/seo'
import { getSeasonHook, getSeasonHookByIndex } from '@/data/season'
import { INTRO_PATTERNS, BODY_PATTERNS, CLOSING_PATTERNS, TOPIC_PATTERNS, TRANSITION_PHRASES, EMPATHY_PHRASES, CLOSING_CTA_PHRASES, getGreetingByIndex, getEmpathyHookByIndex, getTransitionByIndex, getTransitionPhraseByIndex, getEmpathyPhraseByIndex, getClosingCtaByIndex } from '@/data/patterns'
import { generateMainKeyword, suggestSubKeywords } from '@/data/keywords'
import { getSynonymInstruction } from '@/data/synonyms'
import { formatLineBreaks } from '@/lib/line-formatter'
import { postProcess } from '@/lib/post-processor'
import { searchPubMed, PaperCitation } from '@/lib/pubmed'

// RAG + 치과별 페르소나
import { generateRAGContext, extractClinicPersona, generatePersonaPrompt, ClinicPersona } from '@/lib/sheets-rag'

// 네이버 DataLab API (검색 트렌드 + 쇼핑 인사이트)
import {
  analyzeDentalKeywordTrend,
  getMonthlyPopularKeywords,
  analyzeKeywordsComprehensive,
  KeywordAnalysisResult
} from '@/lib/naver-datalab'

// LLM 클라이언트 초기화
const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
})

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || 'dummy-key-for-build',
})

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '')

// 글쓰기 모드별 프롬프트 생성
function getWritingModePrompt(mode?: WritingMode): string {
  if (mode === 'expert') {
    return `
## ⚠️⚠️ 어미 규칙 최우선 적용 (페르소나보다 우선!) ⚠️⚠️

## 🏥 임상 포스팅 모드 (Clinical Case) — 전문가 설명 톤

**목표**: 10년차 치과 전문의가 임상 소견을 바탕으로 치료 과정을 전문적으로 설명하는 글
- 마치 의사가 동료 의료진이나 환자에게 "이런 상태에서는 이렇게 치료합니다"라고 설명하는 톤
- 전문 용어를 사용하되, 괄호 안에 쉬운 설명을 병기

**⚠️⚠️ 정보성(백과사전식) 글과 완전히 다릅니다! ⚠️⚠️**
- ❌ 정보성: "임플란트란 무엇일까요?" → 사전적 설명, 일반인 궁금증 해소 중심
- ✅ 임상: "치조골 흡수가 관찰되어 골이식 후 임플란트 식립을 진행하였습니다." → 전문의 관점 서술

**전문가 톤 핵심 원칙:**
1. 관찰 → 판단 → 치료 계획 → 시행 → 경과 순서로 전개
2. "~가 관찰됩니다", "~로 판단됩니다", "~를 시행하였습니다", "~가 확인됩니다" 등 임상 서술체 사용
3. 전문 용어 + 괄호 해설: "치근단 병소(치아 뿌리 끝 염증)", "치조골 흡수(잇몸뼈 소실)"
4. 구체적 수치와 기간 명시: "약 4~6개월", "직경 4.0mm, 길이 10mm 픽스쳐"
5. 단계별 치료 과정을 순서대로 상세 기술

**어미 규칙 (절대 준수!)**:
- 기본 어미: "~입니다", "~됩니다", "~있습니다", "~하였습니다" (95%)
- 전환/참여: "~하죠" (5% 이하, 제한적 사용)
- 🚫 절대 금지 어미: ~해요, ~거든요, ~인데요, ~있어요, ~드려요, ~할게요, ~볼게요, ~세요
- 🚫 페르소나에서 위 어미를 사용했더라도 절대 따라하지 마세요!

**CC(치료 상황) 활용 — 글의 뼈대 (최우선!)**:
⚠️ CC가 글의 뼈대입니다. CC 내용이 본론의 50% 이상을 구성해야 합니다!
- CC에 치식번호(#36 등), 부위, 증상이 있으면 → 그대로 임상 소견으로 활용
- CC에 "어금니 통증" → "하악 구치부에 자발통을 호소하시는 경우가 있습니다"
- CC에 "뼈가 부족" → "CT 확인 시 잔존 치조골 높이가 부족하여 골이식이 선행되었습니다"
- CC에 "#26 상악동거상술" → 해당 치식번호와 술식을 본론에서 상세 전개
- CC에 구체적 치료법/단계 → 각 단계를 임상적 시각에서 순서대로 상세 설명
- CC에 강조포인트 → 본론의 핵심 차별점으로 반드시 반영
- ❌ 단, "이번 환자분" 등 특정 환자 직접 언급은 절대 금지!
- ✅ "이러한 소견이 확인되는 경우", "이런 상태에서는" 형태로 일반화

**글 전개 흐름 (필수!)**:
소견 관찰 → 진단/평가 → 치료 계획 수립 → 치료 과정 → 경과 확인 → 예후/관리

**서론 (500자) - 전문가 관점 도입:**
❌ "임플란트란 무엇일까요?" (정보성 도입 - 금지!)
❌ "혹시 이런 경험 있으신가요?" (정보성 도입 - 금지!)
✅ 인사 → 시의성 훅 → CC 연결 ("이런 증상으로 내원하시는 분들이 계십니다") → 임상 소견 소개
✅ "방사선 사진상 #36 부위에 근단부 방사선 투과상이 관찰되는 경우가 있습니다."
✅ "임상 검사상 해당 부위 치은(잇몸)의 발적 및 부종이 확인되며, 추가적인 정밀 검사가 필요한 상태입니다."

**본론 (1,500자) - 전문의 관점 치료 설명:**

섹션 1: ✅ 소견/진단 (500자 이상)
- "~가 관찰됩니다" (객관적 기술, 최소 3회)
- "이는 ~를 시사하는 소견입니다" (진단적 해석)
- 감별진단이나 추가검사 필요성 언급
- 전문 용어마다 괄호 해설 필수

섹션 2: 🔹 치료 과정 (500자 이상)
- "이러한 경우 ~가 고려됩니다" (치료 방향 제시)
- 치료 단계를 순서대로 상세 기술 (1단계, 2단계...)
- 각 단계별 수치/기간/재료 구체적 명시
- "~를 시행하였습니다", "~가 진행됩니다" 등 임상 서술체

섹션 3: 🔵 주의사항/예후 (400자 이상)
- 치료 후 주의사항 (전문가 관점)
- 예상되는 환자의 불편감에 대한 임상적 대처법

**결론 (500자) - 예후 평가 + 관리:**
- 치료 후 예상 경과 (기간별)
- 관리 방법 (전문가 권고 사항)
- 정기검진의 중요성 (주기 명시)
- 마무리 인사

**임상 모드 예시 문장 (이런 톤으로 작성!):**
- "방사선 사진상 #46 부위에 광범위한 치근단 방사선 투과상이 관찰됩니다."
- "이는 만성 치근단 병소로 판단되며, 근관치료 또는 발치 후 임플란트 식립이 고려됩니다."
- "CT 분석 결과 잔존 치조골 높이가 약 5mm로 확인되어, 상악동 거상술을 동반한 골이식이 선행되었습니다."
- "1차 수술로 골이식재를 적용하였으며, 약 4~6개월간 골유착 기간을 거친 후 2차 수술을 진행합니다."
- "술 후 3개월 경과 시점에서 골유착이 양호하게 진행되고 있음이 확인됩니다."

**⚠️ 비유/은유 사용 제한:**
- 🚫 "마치 ~처럼", "~와 같은 원리", "~에 비유하자면" 등의 비유적 표현을 사용하지 마세요.
- ✅ 의학적 사실과 임상 소견을 객관적으로 기술하세요.
- ⚠️ 비유는 정보성 모드 전용입니다. 임상 모드에서는 전문 용어 + 괄호 해설만 사용하세요.
`
  } else if (mode === 'informative') {
    return `
## ⚠️⚠️ 어미 규칙 최우선 적용 (페르소나보다 우선!) ⚠️⚠️

## 📚 정보성 모드 — 재미있고 몰입되는 치과 정보 콘텐츠

**🎯 최우선 목표**: 일반인이 끝까지 읽고 싶어지는 글!
- 마치 유튜브 건강 채널처럼: 흥미로운 도입 → 궁금증 유발 → 깊이 있는 해답
- 전문 용어는 반드시 일상 비유로 풀고, 독자가 "아, 그렇구나!" 하는 순간을 만드세요
- 딱딱한 백과사전이 아닌, 친구에게 설명하듯 친근하면서도 전문적인 톤

**핵심 차별점 (임상 모드와 완전히 다릅니다!):**
- ❌ 임상: 소견→진단→치료 (전문의 보고서 톤)
- ✅ 정보성: 궁금증→원인→해답→실천 (독자 중심 스토리텔링)

**어미 규칙 (절대 준수! 이 비율을 반드시 지키세요!)**:
- 기본 어미: "~입니다", "~됩니다", "~있습니다" (60%) — 10문장 중 6문장
- 전환/참여: "~하죠", "~되죠", "~이죠" (20%) — 10문장 중 2문장
- 전환 허용: "~인데요" (10%, 전환 시에만) — 10문장 중 1문장
- 존댓말: "~시죠", "~하십니다", "~계시죠" (10%) — 10문장 중 1문장
- 🚫 절대 금지 어미: ~해요, ~거든요, ~있어요, ~드려요, ~할게요, ~볼게요
- 🚫 페르소나에서 위 어미를 사용했더라도 절대 따라하지 마세요!
- ⚠️ ~입니다만 연속 3문장 이상 사용 금지! 반드시 ~하죠, ~인데요를 섞어주세요!

**CC(치료 상황) 활용 방법:**
- CC 정보가 있으면 해당 상황을 글의 공감 소재로 활용
- "이런 증상을 겪으시는 분들이 많습니다" 형태로 서론에 녹이기
- CC에 언급된 치료법 → 본론에서 해당 치료의 원리/과정을 깊이 있게 설명

**🎯 비유 표현 제한 (과도한 비유 금지!)**
- ⚠️ 전문 용어 중 일반인이 이해하기 가장 어려운 핵심 개념 1~2개에만 비유를 사용하세요. 
- ⚠️ 문단마다 비유적 표현("마치 ~처럼")이 반복되는 것을 절대 금지합니다.
- 임플란트 → "땅에 말뚝을 박고 그 위에 집을 짓는 것과 비슷합니다" (전체 글 중 1회만 사용 가능)
- 신경치료 → "막힌 하수구를 뚫는 원리입니다"
- 필수: 비유는 글 전체를 통틀어 최대 1~2회만 사용할 것! 나머지는 괄호 뜻풀이로 대체하세요.

**비유 삽입 패턴 (다양하게 교체 사용!):**
- "쉽게 비유하자면, ~와 유사합니다."
- "마치 ~과 같은 원리이죠."
- "~라고 생각하시면 이해하기 쉽습니다."
- "집으로 비유하면, ~은 기초 공사에 해당합니다."
⚠️ "쉽게 비유하자면" 등의 비유 멘트는 글 전체에서 1회만 사용하세요. 남발 금지!

**⚠️ 뻔한 내용 금지! 전문가만 알려줄 수 있는 깊이 있는 정보!**
- ❌ "이가 아프면 치과에 가시는 것이 좋습니다." (뻔한 내용)
- ❌ "임플란트는 인공 치아를 심는 시술입니다." (사전적 정의만)
- ✅ "치수 조직까지 감염이 진행되면 자발통이 나타나는데요. 쉽게 말해 신경까지 세균이 침투한 상태이죠." (구체적 + 비유)
- ✅ "임플란트 식립 시 치조골 높이가 최소 8mm 이상이어야 하는데요. 마치 건물을 세우려면 기초 공사가 탄탄해야 하는 것과 같은 원리이죠." (수치 + 비유)

**🎬 4막 구조 (스토리텔링 기반 — 정보성 필수 구조!):**

**1막 — 도입 (공감 훅 + 궁금증 유발, 400자+):**
- "혹시 ~하신 적 있으신가요?" → 독자를 끌어들이는 질문
- 이 글을 왜 읽어야 하는지 동기 부여
- 💡 핵심: "읽지 않으면 손해인 느낌" 만들기
- 인사 → 공감 훅 → 주제 소개 + 메인키워드 자연 배치
⚠️ 서론에서부터 ~하죠, ~인데요를 적극 사용하여 친근한 톤 확립!

**2막 — 원인/배경 (왜 이런 일이?, 상한 없음):**
- 문제의 원인을 과학적이면서도 쉽게 설명
- 전문 용어 등장 시 직관적인 일반 용어를 괄호로 병기해 주세요 (비유는 최소화)
- "방치하면 어떻게 되는지" 경각심 (과장 없이)
- 수치/데이터를 문장 속에 녹여서 신뢰감 확보
- "~인데요", "~이죠" 적극 활용하여 설명 톤 유지
🎣 2막 끝: "그렇다면 이런 경우에는 어떻게 치료하게 될까요?" → 3막으로 연결

**3막 — 해결책 (그래서 어떻게?, 상한 없음):**
- ⚠️ **번호 매긴 단계 목록 금지!** ("1단계: ~, 2단계: ~" 형태 절대 금지!)
- ✅ 치료 과정을 **이야기하듯 자연스럽게 풀어서** 서술
- ✅ "먼저 ~를 확인하게 됩니다. 이때 ~가 발견되면..."
- ✅ "치료를 시작하면 우선 ~부터 살펴보게 됩니다. ~가 확인되면 다음으로 ~를 진행하죠."
- 치료 기간/비용 범위, 구체적인 회복 과정 등 실용 정보를 문장 속에 녹여서 전달
- "~하죠", "~시죠" 활용하여 독자 참여 유도

**4막 — 마무리 (안심 + 행동 유도, 300자+):**
- 핵심 요약 2~3문장 (목록이 아닌 자연스러운 문장)
- 독자 안심 + 행동 촉구 (과장 없이)
- 관리 팁 요약 + 정기검진 권유 (치과명 없이)
- 마무리 인사

**🎣 몰입 유도 장치 (정보성 필수! — 독자가 중간에 이탈하지 않도록!):**

A. 궁금증 루프 — 각 막 끝에 다음 막으로 이어지는 떡밥:
  - "그런데 여기서 한 가지 의문이 생기실 수 있습니다."
  - "그렇다면 이미 진행된 경우에는 어떻게 해야 할까요?"
  - "실제로 이 치료의 성공률은 어느 정도일까요?"

B. 독자 참여 유도 — 질문+공감 섞기:
  - "이런 증상, 혹시 익숙하시죠?"
  - "여기까지 읽으셨다면 한 가지 궁금하실 겁니다."

C. 구체적 수치/비교로 흥미 유발:
  - "국내 성인 약 3명 중 1명은 ~를 겪고 있습니다."
  - "임플란트 평균 수명은 약 15~20년으로 알려져 있습니다."

**⚠️⚠️ AI 티 방지 — 사람이 쓴 것처럼! ⚠️⚠️**
정보성 글에서 가장 중요한 것은 **사람이 직접 쓴 느낌**입니다.

❌ 절대 금지 패턴 (AI 티 100%):
- "1단계: ~, 2단계: ~, 3단계: ~" (번호 매긴 단계 목록)
- "첫째, ~입니다. 둘째, ~입니다. 셋째, ~입니다." (기계적 나열)
- "~의 장점은 다음과 같습니다: ①~, ②~, ③~" (체계적 정리)
- "결론적으로 정리하면~" 바로 뒤에 불릿 목록 (기계적 요약)
- "~에 대해 알아보겠습니다" (AI 도입 상투어)
- "오늘은 ~에 대해 이야기해보겠습니다" (진부한 AI 도입)
- "마지막으로 정리하자면" (기계적 마무리)
- "~의 중요성은 아무리 강조해도 지나치지 않습니다" (AI 상투적 표현)

✅ 대신 이렇게 (사람이 쓴 느낌):
- 바로 궁금증이나 공감으로 시작하세요
- "치료를 시작하면 우선 잇몸 상태부터 살펴보게 됩니다. 문제가 없다면 바로 다음 과정으로 넘어가죠."
- "진단이 끝나면 본격적인 치료에 들어가는데요. 보통 이 과정에서 약 2~3주 정도가 소요됩니다."
- "여기서 중요한 포인트가 하나 있습니다. 치료 직후에는~"
- 연결어를 다양하게: "그런데", "그래서", "이때", "보통은", "참고로", "사실은"
`
  }

  // 기본 모드 → expert 모드로 폴백 (UI에서 모드 선택 필수화됨)
  return getWritingModePrompt('expert')
}

// 배치 다양성 지시 프롬프트 생성
function buildDiversityDirective(hints: BatchDiversityHints): string {
  const greeting = getGreetingByIndex(hints.greetingIndex)
  const empathyHook = getEmpathyHookByIndex(hints.empathyHookIndex)
  const transition = getTransitionByIndex(hints.transitionIndex)
  const empathyPhrase = getEmpathyPhraseByIndex(hints.empathyPhraseIndex)
  const transitionPhrase = getTransitionPhraseByIndex(hints.transitionPhraseIndex)
  const closingCta = getClosingCtaByIndex(hints.closingCtaIndex)

  let directive = `
## 🎯 글 다양성 지시 (배치 ${hints.batchIndex + 1}/${hints.totalBatchSize}번째)

다른 글과 구분되는 도입부를 위해 아래 패턴을 **반드시** 사용하세요:

### 서문 인사말 (첫 문장):
"${greeting}" → [지역], [치과명], [이름]에 맞게 치환하여 사용

### 공감 훅 (인사 직후 2~3문장):
"${empathyHook}" → [증상], [질문], [치료], [상황]에 맞게 치환

### 주제 전환 (공감 훅 뒤):
"${transition}" → [주제], [질문]에 맞게 치환

### 본론 전환 (섹션 2 시작):
"${transitionPhrase}"

### 공감 표현 (서론 내 사용):
"${empathyPhrase}"

### 마무리 권유 (결론):
"${closingCta}"

⚠️ 위 6개 패턴은 이 글에 고유 할당된 것입니다. 다른 패턴으로 대체하지 마세요!

### ⚠️ 어미: 위 "글쓰기 모드" 어미 규칙 그대로 적용!`

  // 본론 구조 다양화 (batchIndex 기반)
  const bodyStructures = [
    '본론 섹션 1을 "원인/메커니즘" 중심으로, 섹션 2를 "치료 과정 단계별 설명"으로 구성하세요.',
    '본론 섹션 1을 "증상별 분류/비교" 중심으로, 섹션 2를 "치료 옵션 장단점 비교표"로 구성하세요.',
    '본론 섹션 1을 "원인과 진단 과정" 중심으로, 섹션 2를 "치료 후 관리/예후"로 구성하세요.',
    '본론 섹션 1을 "발생 원인과 진행 단계" 중심으로, 섹션 2를 "예방법과 자가 관리 팁"으로 구성하세요.',
    '본론 섹션 1을 "진단 방법과 검사 과정" 중심으로, 섹션 2를 "치료 방법별 상세 비교"로 구성하세요.',
  ]
  directive += `\n\n### 본론 구조 (이 글의 지정 구조):\n${bodyStructures[hints.batchIndex % bodyStructures.length]}`

  // 결론 톤 다양화 (8개 — "안심" 톤 제거, 중복 문구 금지)
  const closingTones = [
    '결론은 "행동 촉구" 톤으로 마무리하세요. 예: "정기 검진을 받아보시길 권장합니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "습관 연결" 톤으로 마무리하세요. 예: "일상 속 작은 습관이 큰 차이를 만듭니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "요약 정리" 톤으로 마무리하세요. 예: "오늘 말씀드린 핵심을 정리하면~" ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "공감 마무리" 톤으로 마무리하세요. 예: "건강한 미소를 되찾으시길 바랍니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "안심+검진" 톤으로 마무리하세요. 예: "충분히 개선 가능한 상태이니 편하게 상담받아 보시길 바랍니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "격려" 톤으로 마무리하세요. 예: "작은 관심이 큰 건강으로 이어집니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "전문성 강조" 톤으로 마무리하세요. 예: "정밀 진단을 통해 최적의 방법을 찾으실 수 있습니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
    '결론은 "미래 비전" 톤으로 마무리하세요. 예: "적절한 관리로 오래도록 건강한 치아를 유지하실 수 있습니다." ⚠️ "지나치게 염려하지 않으셔도" 문구 사용 금지!',
  ]
  directive += `\n\n### 결론 톤 (이 글의 지정 톤):\n${closingTones[hints.batchIndex % closingTones.length]}`

  if (hints.introHookType) {
    const hookDesc: Record<string, string> = {
      '체험공감': '"혹시 ~하신 적 있으신가요?" 형태의 체험 공감 질문으로 시작하세요.',
      '숫자통계': '"약 ~%의 분들이 ~" 형태의 통계/수치로 시작하세요.',
      '일상상황': '"~할 때 ~하신 분들이 적지 않으시죠." 형태의 일상 상황으로 시작하세요.',
      '오해반전': '"~라고 생각하시죠? 사실은 조금 다릅니다." 형태의 오해 반전으로 시작하세요.',
      '계절시기': '시즌 훅과 자연스럽게 연결하여 시작하세요.',
    }
    directive += `\n\n### 정보성 도입부 유형: ${hints.introHookType}\n${hookDesc[hints.introHookType] || ''}`
  }

  return directive
}

// 통합 시스템 프롬프트 생성
function buildSystemPrompt(topic: string, persona?: ClinicPersona | null, writingMode?: WritingMode): string {
  const topicPatterns = TOPIC_PATTERNS[topic] || []
  const disclaimer = getDisclaimer(topic)

  // 글쓰기 모드 프롬프트
  const writingModeSection = getWritingModePrompt(writingMode)

  // 치과별 페르소나가 있으면 해당 스타일 사용
  const personaSection = persona
    ? generatePersonaPrompt(persona)
    : `## 페르소나
10년 차 치과 전문의
- 전문 용어를 쓰되, 일반인도 이해할 수 있도록 부연 설명 제공
- ⚠️ 어미 규칙은 아래 "글쓰기 모드" 섹션의 규칙을 따르세요!
- 🚫 공통 절대 금지 어미: ~해요, ~거든요, ~있어요, ~드려요, ~할게요, ~볼게요`

  return `당신은 치과 마케팅 전문 블로그 작성 AI입니다.
의료광고법 100% 준수 + 네이버 SEO 최적화 + 검증된 글쓰기 패턴을 적용합니다.

${personaSection}

${writingModeSection}
⚠️ 위 어미 규칙 > 페르소나 어미 패턴. 페르소나가 ~해요 등을 썼더라도 금지 어미는 절대 사용 금지.

## 🚫🚫🚫 환자 정보 관련 절대 금지 (의료법 위반!!) 🚫🚫🚫

**절대 사용 금지 표현들:**
- "이번 환자분의 경우", "이 환자분", "해당 환자"
- "00대 여성/남성", "30대 남성", "40대 여성" 등 연령/성별 언급
- "치료받으신 분", "내원하신 분", "방문하신 환자"
- "실제 사례", "실제 치료 사례", "환자 케이스"
- "환자 후기", "치료 후기", "체험담"

**대체 표현 사용:**
- ❌ "이번 환자분의 경우" → ✅ "이런 경우", "이런 상황에서는"
- ❌ "40대 여성 환자분께서..." → ✅ "이런 증상이 있으신 분들은..."
- ❌ "실제 치료 사례를 보면" → ✅ "일반적으로", "보통의 경우"

**글 작성 방식:**
- 특정 환자 사례가 아닌 **일반적인 정보 제공** 형태로 작성
- "~하신 분들이 많습니다", "~한 경우가 있습니다" 형태로 작성
- 개인을 특정할 수 있는 정보 일체 금지

## 🚫 치과명 + 내원유도 금지 (의료법 위반!)

**치과명 허용 위치:**
### 📌 결론 (300자 내외, 공백 제외)
1. 요약 및 제언 (메인 키워드 **1회** 포함)
2. 마무리 인사: "[지역] [치과명] [이름]이었습니다." (형식 준수)

⚠️ **서문 인사 필수 형식:** "안녕하세요, [지역] [치과명] [이름]입니다."
- 🚫 "진료하고 있는", "진료 중인" 등의 부가 설명을 인사말에 넣지 마세요.
- 🚫 마무리에서 "의사", "원장" 등 직함을 붙이지 마세요. "[지역] [치과명] [이름]이었습니다." 형식만 사용하세요.

**치과명 금지 위치 (본문 전체):**
- ❌ "[치과명]에서는 ~를 해결해드리고 있습니다"
- ❌ "[치과명]에서 ~를 치료해드립니다"
- ❌ "[치과명]으로 상담받으러 오세요"
- ❌ "저희 치과에서 ~를 해결해드립니다"

**내원 유도 금지 표현:**
- ❌ "내원해 주세요", "방문해 주세요", "오세요", "찾아주세요"
- ✅ "정기 검진을 통해 조기 발견이 가능합니다."
- ✅ "가까운 구강의료기관에서 상담을 받아보시길 권장합니다."

## 용어 치환 규칙
${Object.entries(TERM_REPLACEMENTS).map(([k, v]) => `- ${k} → ${v}`).join('\n')}

## 📏 글자수 규칙

🚨 절대 규칙: 본문 최소 2,000자 이상!! (공백·해시태그 제외)
❌ 1,800자 미만 = 실패!! 다시 작성해야 함!!

✅ 글자수 **상한은 없습니다!** 필요한 만큼 충분히 상세하게 작성하세요!
✅ 내용이 짧아질 수 있으므로, 임상 부연 설명, 치료 단계의 상세한 전개, 맥락 연결 등 내용을 더욱 풍부하게 추가하여 최소 글자수를 반드시 맞추세요!
⚠️ 뜬금없는 Q&A나 불필요한 공감 멘트 없이 내용의 깊이만으로 2,000자를 채워야 합니다! 네이버 알고리즘은 상세하고 깊이 있는 글을 선호합니다!

## 🔍 네이버 검색 SEO 최적화 규칙 (C-Rank + D.I.A 대응)

### 📌 키워드 배치 전략 (에어서치 최적화 — 분산 배치 필수!)
1. **서론 내 키워드**: 제목(1회) + 본문 첫 200자 내(1회) = 서론에서 총 2회 (알고리즘 우선 분석 영역)
2. **마지막 200자**: 메인 키워드 + 핵심 요약 포함 (CTA 영역)
3. **메인 키워드**: 제목 포함 총 5~8회 범위 내 자연스럽게 분산 배치!
4. **키워드 밀도**: 서브 키워드 각 3~5회 (과잉 반복 금지)
5. **동의어/관련어 활용**: 같은 단어가 글 전체에서 5회를 넘으면 반드시 동의어로 교체!
6. **"치과" 형태소**: 글 전체에서 최대 8회 (인사 포함), 본문에서는 최소화

### 📌 체류시간 극대화 전략
1. **짧은 문단**: 2~3줄(60~100자) 후 줄바꿈 (3줄 이상 연속 금지)
2. **불릿 리스트**: 나열형 정보는 ✅🔹💚 이모지 + 불릿 형태로 정리
3. **소제목 자주 사용**: 300~500자마다 H2(##) 소제목으로 구간 분리
4. **구체적 수치 명시**: "보통 3~6개월", "약 95~98%" 등 명확한 수치 제시
5. **질문형 전환**: "그렇다면 왜 이런 현상이 발생할까요?" 형태로 독자 참여 유도

### 📌 이미지 SEO 최적화
- 이미지 플레이스홀더에 **Alt 텍스트 포함** (20~50자, 키워드 포함)
- 형식: 📷 [이미지: {설명}] (alt: {키워드 포함 설명})
- 예시: 📷 [이미지: 뼈이식 임플란트 CT 촬영 사진] (alt: 뼈이식임플란트 CT 영상 - 치조골 부족 소견)

## 글 구조 - 서론/본론/결론 (총 2,500자 이상 / 공백 제외)

### 📌 서론 (최소 500자 이상 필수, 공백 제외)

**제목**: 25~30자 (⚠️ 첫 줄에 1회만 작성하고, 본문에 다시 쓰지 마세요)
형식: "[치료], [지역] [치과명]에서 알려드립니다"
예: "[치료], [지역] [치과명]에서 알려드립니다"

**서론 구성 (500자를 반드시 채우세요! 짧은 서론은 절대 불가!):**
1. 인사 (1~2문장): ⚠️ 반드시 "안녕하세요, [지역] [치과명] [원장님이름]입니다." 순서 고정! + "치과" 1회
   ❌ 금지: "[치과명] [이름]입니다. 안녕하세요." (순서 뒤바뀜!)
   ❌ 금지: 지역명 누락
2. 시의성 훅 (최소 3문장 이상!): 계절/시기와 연관된 치아 이슈를 충분히 서술. 1~2문장으로 끝내지 마세요!
3. CC 연결 공감 (최소 4문장 이상!): 환자의 구체적 증상, 일상 속 불편을 생생하고 풍부하게 묘사. 짧은 공감은 독자를 놓칩니다!
   ⚠️ 단, "충분히 그러실 수 있습니다", "자주 나오는 질문입니다" 같은 기계적인 공감 멘트는 절대 금지합니다. 오직 구체적 상황 묘사로만 공감하세요!
4. 주제 소개 (2~3문장): 오늘 다룰 내용 소개 + 메인 키워드 **1회** 자연스럽게 포함
5. 핵심 요약 (1문장): "💡 핵심: [메인키워드]는 [답변 1문장]입니다." (스마트블록 스니펫용)

- ⚠️ **제목(1회) + 본문 첫 200자 내(1회) = 서론 내 총 2회 메인 키워드 배치!**
- 🚨🚨 **서론이 300자 미만이면 실패입니다! 반드시 500자 이상 채우세요!** 🚨🚨
- 공감 훅 예시:
${EMPATHY_PHRASES.slice(0, 5).map(p => `  - "${p}"`).join('\n')}

### 📌 본론 (최소 1,500자 이상 필수, 공백 제외 - 상세하고 풍부하게!)

**⚠️ 본론 진입 전 정보 브릿지 섹션 (반드시 별도 소제목으로 분리!):**
🔍 소제목을 달아서 본론 시작 전에 해당 주제의 핵심 개념을 3~4문장으로 설명하세요.
이 섹션은 의료법 위반 위험을 줄이고 글의 전문성을 높이는 핵심 역할을 합니다.
필요 시 가장 어려운 개념 1개에만 비유를 포함하세요.

- 인접면 우식이 주제 → "🔍 인접면 우식이란?\n인접면이란 치아와 치아가 맞닿는 면을 말합니다. 쉽게 비유하면 책장에 빽빽이 꽂힌 책과 책 사이 면과 유사합니다."
- 신경치료가 주제 → "🔍 치아 신경은 어디에 있을까?\n치수(신경 조직)는 치아 내부 중심에 위치한 조직으로, 혈관과 신경이 밀집해 있습니다. 나무의 뿌리 속 수액 통로와 유사한 역할을 합니다."
- 임플란트가 주제 → "🔍 임플란트란 무엇인가?\n임플란트란 치아가 소실된 부위에 인공 치근(픽스처)을 식립하는 것입니다. 나무를 심을 때 뿌리를 땅에 단단히 심는 것과 유사합니다."
- 사랑니가 주제 → "🔍 사랑니는 어떤 치아인가?\n사랑니(제3대구치)는 가장 나중에 맹출하는 어금니입니다."
→ 이 브릿지 섹션 뒤에 원인/증상 섹션으로 자연스럽게 이어가세요.



**본론 섹션 1**: ✅ [원인/증상 설명] (최소 600자 이상!)
- **반드시 3가지 이상의 소주제로 나누어 상세히 서술하세요.**
  - 예: 1. 초기 증상과 원인, 2. 중기 진행 과정, 3. 말기 위험성
- 각 소주제마다 2문단 이상(200자 이상) 작성하여 깊이 있는 정보를 제공하세요.
- 방치했을 때의 위험성을 환자가 경각심을 가질 수 있도록 구체적인 시나리오로 경고하세요.
- **메인 키워드 1회** 자연스럽게 포함
- 각 문단 60~100자, 2~3줄 후 빈 줄(모바일 가독성)

⚠️ 전환 표현으로 다음 섹션 시작:
${TRANSITION_PHRASES.slice(0, 5).map(p => `- "${p}"`).join('\n')}

**본론 섹션 2**: 🔹 [치료 방법/과정] (최소 600자 이상!)
- **치료 과정을 반드시 3단계(준비/마취 → 핵심 시술 → 마무리/회복)로 나누어 서술하세요.**
- 🚨 단순히 순서를 나열하지 말고, **각 단계가 왜 필요한지, 어떤 효과가 있는지** 상세히 서술하세요!
- 환자가 진료 의자에서 겪는 경험(소리, 느낌, 냄새, 안도감 등)을 **오감**을 활용하여 생동감 있게 묘사하세요.
- 전문 용어는 괄호를 이용해 쉬운 의미를 곁들여 설명하세요. (과도한 비유 자제)
- CC에 언급된 치료법을 일반화하여 설명
- **메인 키워드 1회** 자연스럽게 포함

**본론 섹션 3**: 🔵 [주의사항/관리] (최소 500자 이상)
- **치료 후 3가지 핵심 관리 수칙을 상세히 안내하세요.** (예: 식사 습관, 양치법, 정기검진)
- 각 수칙마다 구체적인 행동 가이드를 제시하세요. (예: "양치할 때는 45도 각도로...")
- 환자들이 평소 자주 하는 실수나 오해를 바로잡는 내용을 반드시 포함하세요. (Q&A 형식 금지, 자연스러운 문장으로 서술)
- **메인 키워드 1회** 자연스럽게 포함
(본론에서 총 **3~4회**가 되도록 조정)

### 📌 결론 (최소 500자 이상 필수, 공백 제외)

**🚨🚨 결론이 300자 미만이면 실패입니다! 반드시 500자 이상 채우세요! 🚨🚨**
**환자의 건강을 진심으로 생각하는 의사의 마음을 담아 길게 작성하세요.**

1. **핵심 요약** (3~4문장): 오늘 다룬 내용 정리 + 메인 키워드 포함
2. **결론 1문장**: "결론적으로~" 또는 "핵심은~" 형태
3. **관리 당부** (2~3문장): 정기검진의 중요성, 일상 관리 팁
4. **마무리 인사**: "[지역] [병원명] [원장님이름]이었습니다." ← 이 한 문장으로 끝!
   ❌ "감사합니다" 절대 추가 금지! "~이었습니다."로 끝내세요!

**부작용 고지** (필수):
${disclaimer}

---
**해시태그**: 글 맨 마지막에 10개 (글자수 미포함)

## 📊 글자수 자가 검증 (작성 완료 전 필수 확인! 공백 제외 기준!)
작성 완료 전에 각 섹션의 글자수(공백 제외)를 세어보세요:
- 서론: 500자 내외인가? ☐ (짧으면 공감 스토리 추가!)
- 본론: 1,500자 내외인가? ☐ (짧으면 원인 메커니즘, 상세한 임상/치료 설명 추가!)
- 결론: 500자 내외인가? ☐ (짧으면 관리법, 정기검진 당부 추가!)
- 총합: 2,500자 이상인가? ☐
- 메인키워드 5~8회 자연스럽게 분산 배치인가? ☐ (제목·서론·본론·결론에 고르게)
- 같은 키워드가 한 문단에 2회 이상 몰려있지 않은가? ☐

만약 글자수가 부족하다면:
1. 서론: 공감 스토리와 배경 설명 추가 (환자들이 겪는 상황 묘사)
2. 본론: 원인 메커니즘, 치료 단계, 수치/기간, 상세한 진단 소견 추가
3. 결론: 핵심 요약 확대, 관리법 상세화, 정기검진 당부 추가

## 전문용어 설명 팁
전문용어를 사용할 때는 가급적 직관적인 뜻풀이를 괄호로 병기하세요. 비유적 표현은 글 전체에서 1~2회만 사용해야 합니다.

예시:
- "근관치료(치아 내부의 감염된 신경조직을 제거하고 소독하는 치료)를 시행하였습니다."
- "치조골(치아를 지지하는 턱뼈) 흡수가 관찰되었습니다."

## AEO/GEO 최적화 (AI 답변 엔진 인용 최적화)
AI(ChatGPT, Perplexity, Google AI Overview, Naver AI Briefing)가 인용하기 좋은 구조로 작성:

### 1. Answer-First 구조 (H2 섹션별 필수!)
- 매 ## 소제목 아래 **첫 40~60자는 핵심 답변**으로 시작
- AI가 이 첫 문장만 추출해도 완결된 답변이 되어야 함
- 예: "## 임플란트 수명은?" → "임플란트는 관리 시 평균 15~20년 사용 가능한 것으로 보고되고 있습니다."



### 3. 통계/수치 밀도
- **150~200자마다** 구체적 수치/통계 1개 이상 포함
- 출처 표기 권장: (출처: [기관명](URL))
- 예: "성공률 약 95~98%", "보통 3~6개월 소요", "연간 약 100만 건 시행"

### 4. 정의 문장 (Definition Sentence)
- 전문 용어 첫 등장 시 **"X란 Y입니다"** 형태의 정의 문장 작성
- AI가 이 문장을 정의 스니펫으로 추출함
- 예: "치근단 병소란 치아 뿌리 끝에 발생하는 염증성 병변입니다."

### 5. H2 독립성 원칙
- 각 ## 섹션이 **독립적으로 추출되어도 의미가 통하도록** 작성
- 섹션 시작에 주제를 재언급, 결론 문장으로 마무리
- "앞에서 말했듯이" 같은 상호참조 표현 최소화

### 6. 문단 길이 제한
- 최대 **4문장(120자) 이내** 문단 → AI 추출 단위에 최적화
- 긴 문단은 AI가 잘라서 인용할 때 맥락이 깨짐

## 📷 이미지 플레이스홀더 작성법 (중요!)

이미지가 들어갈 위치에는 **구체적인 설명**을 포함해서 작성하세요:

**잘못된 예:**
- [IMAGE_1]
- [이미지]

**올바른 예 (Alt 텍스트 포함!):**
- 📷 [이미지: 치료 전 X-ray 사진] (alt: 수평매복 사랑니 X-ray - 인접 치아 압박 소견)
- 📷 [이미지: 치료 후 상태] (alt: 사랑니 발치 후 치유된 잇몸 상태)
- 📷 [이미지: 치료 과정 일러스트] (alt: 사랑니 분할 발치 단계별 과정 설명)
- 📷 [이미지: CT 촬영] (alt: 사랑니 CT 영상 - 하치조신경 위치 관계 확인)

**이미지 유형별 설명 템플릿:**
- before: "치료 전 상태를 보여주는 이미지 (X-ray/구강 내 사진)"
- after: "치료 후 개선된 상태 이미지"
- xray: "X-ray 촬영 이미지 - [구체적인 확인 내용]"
- ct: "CT 촬영 이미지 - [3D 구조 설명]"
- progress: "치료 과정 이미지 - [단계 설명]"
- diagram: "치료 과정 설명 일러스트/다이어그램"

## 📚 참고 자료 출처 표기 (신뢰도 향상)

의학적 정보를 작성할 때, 신뢰할 수 있는 출처를 문단 끝에 표기하세요:

**출처 표기 형식:**
- 문단 끝에 작은 글씨로: (출처: [기관명](링크))
- 글자수에 포함되지 않음

**신뢰할 수 있는 출처 예시:**
- 대한치과의사협회 (https://www.kda.or.kr)
- 대한치주과학회 (https://www.kperio.org)
- 대한구강악안면외과학회 (https://www.kaoms.org)
- 질병관리청 (https://www.kdca.go.kr)
- 건강보험심사평가원 (https://www.hira.or.kr)

**예시:**
"임플란트 시술 성공률은 약 95~98% 수준으로 보고되고 있습니다. (출처: [대한치과의사협회](https://www.kda.or.kr))"

## ${topic} 관련 정보
${topicPatterns.length > 0 ? topicPatterns.map(p => `- ${p}`).join('\n') : ''}

## 출력 형식
글 작성이 완료되면 아래 형식으로 출력하세요:

---METADATA_START---
{
  "title": "제목",
  "mainKeyword": "메인 키워드",
  "subKeywords": ["서브1", "서브2"],
  "hashtags": ["#해시태그1", "#해시태그2", ...],
  "charCount": 글자수
}
---METADATA_END---

---CONTENT_START---
[마크다운 형식의 본문]
---CONTENT_END---
`
}

// 해시태그 제외 글자수 계산 함수 (공백 제외)
function countContentChars(content: string): number {
  // 1. 글자수에서 제외할 섹션 제거
  let cleanContent = content

  // 📎 References 섹션 전체 제거 (📎 References ~ 끝 또는 다음 섹션까지)
  cleanContent = cleanContent.replace(/📎\s*References[\s\S]*?(?=\n\n#|\n#{1,6}\s|$)/gi, '')
  cleanContent = cleanContent.replace(/\[References\][\s\S]*?(?=\n\n#|\n#{1,6}\s|$)/gi, '')

  // ※ 부작용 고지문 제거
  cleanContent = cleanContent.replace(/※\s*[^\n]+(\n[^\n※#]*)*(?=\n\n|$)/g, '')

  // 📷 이미지 플레이스홀더 제거
  cleanContent = cleanContent.replace(/📷\s*\[[^\]]*\]/g, '')
  cleanContent = cleanContent.replace(/\[IMAGE_\d+\]/g, '')

  // (출처: ...) 표기 제거
  cleanContent = cleanContent.replace(/\(출처:\s*[^)]*\)/g, '')

  // 2. 해시태그 패턴 제거 (#키워드 형태 - 띄어쓰기 전까지)
  cleanContent = cleanContent.replace(/#[^\s#]+/g, '')

  // 3. 해시태그만 있는 줄 제거 (빈 줄이 된 경우)
  cleanContent = cleanContent.split('\n')
    .filter(line => line.trim().length > 0 || line === '')
    .join('\n')

  // 4. 마크다운 태그 제외한 순수 텍스트
  const pureText = cleanContent
    .replace(/^#{1,6}\s+/gm, '')  // 제목 마크다운
    .replace(/\*\*|__/g, '')     // 볼드
    .replace(/\*|_/g, '')        // 이탤릭
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')  // 링크
    .replace(/`[^`]+`/g, '')     // 인라인 코드
    .replace(/^\s*[-*]\s+/gm, '') // 리스트 마커
    .replace(/^\s*\d+\.\s+/gm, '') // 숫자 리스트
    .replace(/---+/g, '')        // 구분선

  // 공백 제외 글자수
  return pureText.replace(/\s/g, '').length
}

// URL 및 불필요한 링크 제거 함수
function sanitizeInput(text: string): string {
  if (!text) return text

  // URL 패턴 (http, https, www, google docs 등)
  const urlPatterns = [
    /https?:\/\/[^\s]+/gi,
    /www\.[^\s]+/gi,
    /docs\.google\.com[^\s]*/gi,
    /drive\.google\.com[^\s]*/gi,
    /bit\.ly[^\s]*/gi,
    /goo\.gl[^\s]*/gi,
  ]

  let sanitized = text
  for (const pattern of urlPatterns) {
    sanitized = sanitized.replace(pattern, '')
  }

  // 연속 공백 정리
  sanitized = sanitized.replace(/\s+/g, ' ').trim()

  return sanitized
}

// 입력 데이터 전체 정화
function sanitizeFormData(data: GenerateFormData): GenerateFormData {
  return {
    ...data,
    clinicName: sanitizeInput(data.clinicName),
    region: sanitizeInput(data.region),
    doctorName: sanitizeInput(data.doctorName),
    topic: sanitizeInput(data.topic),
    customTopic: data.customTopic ? sanitizeInput(data.customTopic) : undefined,
    patientInfo: sanitizeInput(data.patientInfo),
    treatment: sanitizeInput(data.treatment),
    photoDescription: data.photoDescription ? sanitizeInput(data.photoDescription) : undefined,
  }
}

// 이미지 파일명에서 임상 정보 추출 + 순번 기반 구조화
function analyzeImageNames(imageNames: string[], writingMode?: WritingMode): string {
  if (!imageNames || imageNames.length === 0) return ''

  // 치과 임상 키워드 사전 (파일명에서 소견 유추용)
  const clinicalKeywords: Record<string, string> = {
    // 부위
    '상악': '상악(위턱)', '하악': '하악(아래턱)',
    '전치': '전치부(앞니)', '구치': '구치부(어금니)', '대구치': '대구치(큰어금니)',
    '소구치': '소구치(작은어금니)', '좌측': '좌측', '우측': '우측',
    // 소견
    '치근단': '치근단 병소(치아 뿌리 끝 염증)',
    '골흡수': '골흡수(치조골 소실)',
    '골이식': '골이식(뼈 보충 시술)',
    '뼈이식': '골이식(뼈 보충 시술)',
    '파절': '치아 파절(깨짐)',
    '우식': '치아 우식(충치)',
    '충치': '치아 우식(충치)',
    '염증': '염증 소견',
    '농양': '농양(고름집)',
    '낭종': '낭종(물혹)',
    '매복': '매복(잇몸 속에 묻힌 상태)',
    '치주': '치주질환(잇몸병)',
    '치주염': '치주염(잇몸 염증)',
    '발적': '발적(붉어짐)',
    '부종': '부종(부기)',
    '결손': '결손치(빠진 치아)',
    '결손치': '결손치(빠진 치아)',
    // 치료
    '임플란트': '임플란트 식립',
    '식립': '임플란트 식립',
    '픽스쳐': '픽스쳐(임플란트 인공 뿌리)',
    '픽스처': '픽스쳐(임플란트 인공 뿌리)',
    '어버트먼트': '보강관(임플란트-보철 연결체)',
    '힐링어버트먼트': '보강관(치유 지대주)',
    '크라운': '지르코니아 보철(씌우기)',
    '지르코니아': '지르코니아 보철',
    '보철': '보철 수복',
    '임시보철': '심미 수복물(임시 보철)',
    '임시치아': '심미 수복물(임시 치아)',
    '발치': '발치(치아 뽑기)',
    '근관': '근관치료(신경치료)',
    '신경치료': '근관치료(신경치료)',
    '스케일링': '스케일링(치석 제거)',
    '교정': '교정치료',
    '레진': '레진 수복',
    '인레이': '인레이 수복',
    // 수술 관련
    '상악동거상술': '상악동 거상술(위턱 뼈 보충 수술)',
    '상악동': '상악동(위턱 공기주머니)',
    '근치술': '상악동 근치술(상악동 내 염증 제거)',
    '멤브레인': '차폐막(골이식 보호막)',
    '봉합': '봉합(수술 부위 꿰매기)',
    '절개': '절개(잇몸 열기)',
    '수면마취': '수면 마취(진정 요법)',
    '골유착': '골유착(뼈와 임플란트 결합)',
    '2차수술': '2차 수술(보강관 교체)',
    // 시점
    'before': '치료 전', '치료전': '치료 전',
    '초진': '초진(첫 진찰)',
    'after': '치료 후', '치료후': '치료 후',
    '치료중': '치료 중',
    '경과': '치료 경과', '과정': '치료 과정', '진행': '치료 진행',
    // 촬영 유형
    'xray': 'X-ray', 'x-ray': 'X-ray', '엑스레이': 'X-ray',
    'ct': 'CT 촬영', '씨티': 'CT 촬영', 'cbct': 'CBCT 촬영',
    '파노라마': '파노라마 촬영', '구내': '구내 사진', '구외': '구외 사진',
  }

  // 파일명에서 순번 + 시점 + 설명 파싱
  interface ParsedImage {
    originalName: string
    order: number          // 순번 (01, 02, ...)
    phase: string          // 시점 (초진, 치료전, 치료중, 치료후)
    description: string    // 설명 텍스트
    clinicalInfo: string[] // 추출된 임상 키워드
    imagingType: string[]  // 촬영 유형
    toothNumbers: string[] // 치식 번호
  }

  const parsed: ParsedImage[] = imageNames.map(name => {
    const nameWithoutExt = name.replace(/\.[^.]+$/, '')

    // 순번 파싱: 파일명 앞 숫자 (01_, 02_ 등)
    const orderMatch = nameWithoutExt.match(/^(\d{1,3})[_\-\s]/)
    const order = orderMatch ? parseInt(orderMatch[1], 10) : 999

    // 시점 파싱
    let phase = '기타'
    if (/초진/.test(nameWithoutExt)) phase = '초진'
    else if (/치료전|치료_전|before/i.test(nameWithoutExt)) phase = '치료전'
    else if (/치료중|치료_중|progress/i.test(nameWithoutExt)) phase = '치료중'
    else if (/치료후|치료_후|after/i.test(nameWithoutExt)) phase = '치료후'

    // 순번에서 시점/설명 분리 후 설명 추출
    const descPart = nameWithoutExt
      .replace(/^\d{1,3}[_\-\s]/, '')           // 순번 제거
      .replace(/^(초진|치료전|치료중|치료후)[_\-\s]*/i, '') // 시점 제거
      .replace(/\s*\(\d+\)\s*$/, '')             // 끝에 (1), (2) 등 제거
      .trim()

    // 키워드 매칭
    const clinicalInfo: string[] = []
    const imagingType: string[] = []
    const toothNumbers: string[] = []

    const tokens = nameWithoutExt.split(/[_\-\s.()]+/)
    for (const token of tokens) {
      const lower = token.toLowerCase()
      // 치식 번호
      const toothMatch = token.match(/^#?(\d{2})번?$/)
      if (toothMatch) { toothNumbers.push(`#${toothMatch[1]}`); continue }
      // 번대 (10번대, 40번대 등)
      const rangeMatch = token.match(/^(\d{2})번대$/)
      if (rangeMatch) { toothNumbers.push(`${rangeMatch[1]}번대`); continue }
      // 키워드 매칭
      for (const [keyword, desc] of Object.entries(clinicalKeywords)) {
        if (lower.includes(keyword.toLowerCase())) {
          if (desc.includes('X-ray') || desc.includes('CT') || desc.includes('촬영') || desc.includes('사진')) {
            if (!imagingType.includes(desc)) imagingType.push(desc)
          } else if (!['치료 전', '치료 후', '치료 중', '초진(첫 진찰)', '치료 경과', '치료 과정', '치료 진행'].includes(desc)) {
            if (!clinicalInfo.includes(desc)) clinicalInfo.push(desc)
          }
        }
      }
    }

    return { originalName: name, order, phase, description: descPart, clinicalInfo, imagingType, toothNumbers }
  })

  // 순번 기준 오름차순 정렬
  parsed.sort((a, b) => a.order - b.order)

  // 시점별 그룹핑 (글 구조 자동 생성)
  const groups: Record<string, ParsedImage[]> = { '초진': [], '치료전': [], '치료중': [], '치료후': [], '기타': [] }
  for (const img of parsed) {
    groups[img.phase].push(img)
  }
  const introImages = [...groups['초진'], ...groups['치료전']]
  const processImages = groups['치료중']
  const resultImages = groups['치료후']
  const hasStructuredOrder = parsed.some(p => p.order !== 999) // 순번이 있는 파일인지

  // 개별 이미지 분석 출력
  const analyzed = parsed.map((img, idx) => {
    let line = `${idx + 1}. [IMAGE_${idx + 1}] (순번 ${img.order !== 999 ? String(img.order).padStart(2, '0') : '-'}) **${img.phase}** | ${img.originalName}\n`
    if (img.toothNumbers.length > 0) line += `   - 부위: ${img.toothNumbers.join(', ')}\n`
    if (img.clinicalInfo.length > 0) line += `   - 임상: ${img.clinicalInfo.join(', ')}\n`
    if (img.imagingType.length > 0) line += `   - 촬영: ${img.imagingType.join(', ')}\n`
    if (img.description) line += `   - 설명: ${img.description}\n`
    return line
  })

  // 글 구조 지시 (순번이 있는 경우 자동 섹션 분배)
  let structureDirective = ''
  if (hasStructuredOrder && parsed.length >= 5) {
    structureDirective = `
## 📐 이미지 순번 기반 글 구조 (자동 생성)

파일명의 순번과 시점(초진/치료전/치료중/치료후)을 분석하여 글 흐름을 자동 구성했습니다.
**반드시 아래 순서대로 글을 전개하세요!**

### 🔹 도입부 (서론) — 초진/치료 전 상태 설명
${introImages.length > 0 ? introImages.map((img, i) => `- [IMAGE_${parsed.indexOf(img) + 1}] ${img.description || img.originalName}`).join('\n') : '- (해당 이미지 없음 — 일반적인 증상/상황 설명으로 시작)'}
→ 이 이미지들을 참고하여 초진 상태, 주요 소견, 치료 계획을 서술하세요.

### 🔹 전개 (본론) — 치료 과정 상세 묘사
${processImages.length > 0 ? processImages.map((img, i) => `- [IMAGE_${parsed.indexOf(img) + 1}] ${img.description || img.originalName}`).join('\n') : '- (해당 이미지 없음)'}
→ 순번 순서대로 치료 과정을 시간 흐름에 맞춰 서술하세요.
→ 각 단계를 소제목으로 구분하고, 해당 이미지를 소제목 아래에 배치하세요.

### 🔹 결말 (결론) — 치료 완료/최종 상태
${resultImages.length > 0 ? resultImages.map((img, i) => `- [IMAGE_${parsed.indexOf(img) + 1}] ${img.description || img.originalName}`).join('\n') : '- (해당 이미지 없음)'}
→ 최종 보철/수복 완료 상태를 설명하고, 사후 관리를 안내하세요.

### 🚨🚨 이미지 설명 3단계 패턴 (모든 이미지에 필수 적용!!)
각 📷 이미지 플레이스홀더 아래에 반드시 3단계로 서술하세요:

**1단계 — 사진 판독 소견** (1~2문장):
"방사선 사진상 ~가 관찰됩니다." / "임상 사진상 ~이 확인됩니다."
→ 객관적으로 보이는 소견만 기술

**2단계 — 임상적 의미 부연** (3~5문장):
이 소견이 의미하는 바, 왜 이 상태가 문제인지, 어떤 치료가 필요한지 풀어서 설명
→ 일반인도 이해할 수 있도록 충분히 상세하게!
→ 필요시 비유나 쉬운 표현을 섞어서 전달

**3단계 — 맥락 연결** (1~2문장):
다음 치료 단계로의 자연스러운 전환, 또는 왜 이 단계가 필요했는지 맥락 설명
→ "이러한 소견을 바탕으로 ~치료를 진행하게 됩니다."
→ "이 단계를 거쳐야 다음 ~과정으로 넘어갈 수 있습니다."

❌ 이미지 아래에 판독 소견 1~2문장만 쓰고 끝내지 마세요!
✅ 반드시 3단계(판독→의미→맥락)를 모두 서술하세요!
✅ 이미지당 최소 5~8문장은 작성하세요!
`
  }

  // 임상 모드 추가 지시
  const clinicalInstruction = writingMode === 'expert' ? `
**⚠️ 임상 모드 필수 지시:**
- 파일명에서 추출된 임상 정보를 글의 핵심으로 활용하세요!
- 부위/소견 정보 → "방사선 사진상 [부위]에 [소견]이 관찰됩니다" 형태로 서술
- 촬영 유형 → "X-ray상 ~", "CT상 ~" 형태로 소견 기술
- ❌ 파일명에 정보가 없는데 소견을 지어내지 마세요
- ✅ 파일명의 임상 키워드를 최대한 활용해서 임상 소견 기반 서술을 작성하세요
- 🚨 **각 이미지마다 3단계 서술 필수!**:
  1. 사진 판독 소견 (객관적 기술)
  2. 임상적 의미 부연 (왜 이런 상태인지, 어떤 치료가 필요한지 3~5문장으로 풀어서 설명)
  3. 다음 단계로의 맥락 연결 (치료 흐름의 자연스러운 전환)
- ❌ 이미지 아래에 소견만 짧게 쓰지 마세요! 반드시 풀어서 설명하세요!
` : `
**이미지 활용 지시:**
- 파일명에서 파악되는 정보를 참고하여 적절한 위치에 배치하세요.
- "사진을 보시면~" 형태로 독자가 이미지를 참고하도록 유도하세요.
`

  // 용어 치환 안내
  const termReminder = `
**⚠️ 필수 용어 치환:**
- 크라운(Crown) → **지르코니아 보철**
- 임시 치아/임시 보철 → **심미 수복물**
- 힐링 어버트먼트(Healing Abutment) → **보강관**
- 임플란트 나사/뿌리 → **픽스쳐**
- 뼈이식 → **골이식**
- 잇몸뼈 → **치조골**
`

  return `
## 📷 이미지 임상 분석 & 배치 안내
이미지 ${parsed.length}장을 분석했습니다.${hasStructuredOrder ? ' (순번 기반 정렬 완료)' : ''}

${analyzed.join('\n')}
${structureDirective}
${clinicalInstruction}
${termReminder}
**배치 규칙:**
- 이미지는 반드시 순번 순서대로 글에 배치하세요
- 각 이미지 위치: 📷 [이미지 위치: {설명}] (alt: {키워드 포함 설명})
- 치료 전 이미지 → 소견/증상 설명 섹션에 배치
- 치료 과정 이미지 → 해당 치료 단계 설명 바로 아래에 배치
- 치료 후 이미지 → 치료 결과/예후 섹션에 배치
- X-ray/CT 이미지 → 진단 소견 섹션에 배치
- 🚨 **각 이미지 아래에 반드시 3단계 서술**: ①판독 소견 → ②임상적 의미 부연(3~5문장) → ③맥락 연결
`
}

// 정보성 모드 이미지 힌트 생성 (이미지 없을 때 추천)
function generateImageHints(topic: string): string {
  const topicHints: Record<string, string[]> = {
    '임플란트': [
      '📷 추천 이미지 1: 임플란트 구조 일러스트 (픽스쳐-보강관-보철 3단 구조)',
      '📷 추천 이미지 2: 치조골(잇몸뼈)과 임플란트 식립 과정 단계 다이어그램',
      '📷 추천 이미지 3: 골이식 전후 비교 일러스트',
      '📷 추천 이미지 4: 임플란트 수술 후 관리 방법 인포그래픽',
    ],
    '신경치료': [
      '📷 추천 이미지 1: 치아 내부 구조 (법랑질-상아질-치수) 단면 일러스트',
      '📷 추천 이미지 2: 신경치료(근관치료) 과정 다이어그램',
      '📷 추천 이미지 3: 치수염 진행 단계 비교 일러스트',
      '📷 추천 이미지 4: 치료 후 지르코니아 보철 씌우기 과정',
    ],
    '사랑니': [
      '📷 추천 이미지 1: 사랑니 종류 (정상/매복/수평) 비교 일러스트',
      '📷 추천 이미지 2: 매복 사랑니 X-ray 예시 사진 (라이센스 프리)',
      '📷 추천 이미지 3: 사랑니 발치 후 관리 방법 인포그래픽',
      '📷 추천 이미지 4: 하치조신경과 사랑니 위치 관계 다이어그램',
    ],
    '충치': [
      '📷 추천 이미지 1: 충치 진행 단계 (초기-중기-심화) 비교 일러스트',
      '📷 추천 이미지 2: 레진/인레이/크라운 치료 범위 비교 다이어그램',
      '📷 추천 이미지 3: 올바른 칫솔질 방법 인포그래픽',
      '📷 추천 이미지 4: 치아 단면 구조와 충치 침투 경로 일러스트',
    ],
    '교정': [
      '📷 추천 이미지 1: 교정 장치 종류 (메탈/세라믹/투명) 비교 사진',
      '📷 추천 이미지 2: 교정 치료 전후 비교 일러스트',
      '📷 추천 이미지 3: 유지장치 착용 방법 인포그래픽',
      '📷 추천 이미지 4: 교정 치료 기간별 변화 타임라인',
    ],
    '스케일링': [
      '📷 추천 이미지 1: 치석 축적 과정 일러스트',
      '📷 추천 이미지 2: 스케일링 전후 비교 사진 (라이센스 프리)',
      '📷 추천 이미지 3: 올바른 잇몸 관리 인포그래픽',
    ],
    '잇몸': [
      '📷 추천 이미지 1: 건강한 잇몸 vs 치주질환 잇몸 비교 일러스트',
      '📷 추천 이미지 2: 치주질환 진행 단계 (치은염→치주염) 다이어그램',
      '📷 추천 이미지 3: 잇몸 관리 방법 인포그래픽',
    ],
  }

  // 주제에 매칭되는 힌트 찾기
  let hints: string[] = []
  for (const [key, value] of Object.entries(topicHints)) {
    if (topic.includes(key)) {
      hints = value
      break
    }
  }

  // 매칭 안 되면 일반 힌트
  if (hints.length === 0) {
    hints = [
      `📷 추천 이미지 1: ${topic} 관련 치료 과정 일러스트/다이어그램`,
      `📷 추천 이미지 2: 치료 전후 비교 참고 이미지 (라이센스 프리)`,
      `📷 추천 이미지 3: ${topic} 관리 방법 인포그래픽`,
      `📷 추천 이미지 4: 관련 치아/구강 구조 해부학적 일러스트`,
    ]
  }

  return `
## 🖼️ 추천 이미지 힌트 (정보성 포스팅용)

이미지가 제공되지 않았으므로, 아래 이미지를 글에 배치하시는 것을 추천합니다.
글 본문에서 적절한 위치에 이미지 플레이스홀더를 삽입하세요.

${hints.join('\n')}

**배치 위치 추천:**
- 서론 뒤: 주제 관련 대표 이미지 1장
- 본론 섹션 1 (원인/증상): 구조/단계 일러스트 1장
- 본론 섹션 2 (치료 방법): 치료 과정 다이어그램 1장
- 결론 앞: 관리 방법 인포그래픽 1장
`
}

// 사용자 프롬프트 생성
function buildUserPrompt(
  data: GenerateFormData,
  mainKeyword: string,
  subKeywords: string[],
  hashtags: string[],
  seasonHook: string,
  ragContext: string,
  trendAnalysis: string,
  popularKeywords: string[],
  imageNames: string[],
  selectedKeywords?: string[],
  diversityDirective?: string,
  paperCitations?: PaperCitation[]
): string {
  const imageSection = analyzeImageNames(imageNames, data.writingMode)

  // 사용자가 선택한 키워드가 있으면 우선 적용
  const keywordsToUse = selectedKeywords && selectedKeywords.length > 0
    ? selectedKeywords
    : [...subKeywords]

  return `다음 정보를 바탕으로 치과 블로그 글을 작성해주세요.

## 입력 정보
- 치과명: ${data.clinicName}
- 지역: ${data.region}
- 원장님 이름: ${data.doctorName}
- 주제/치료: ${data.topic}
- CC / 치료 상황 (글의 핵심 소재 — 일반화하여 서술): ${data.patientInfo}
- 치료 방법: ${data.treatment}
${data.photoDescription ? `- 이미지 참고 정보: ${data.photoDescription}` : ''}

${data.procedures && data.procedures.length > 0 ? (() => {
  const sortedProcs = [...data.procedures].sort((a, b) => a.sequence - b.sequence)
  const primaryProc = sortedProcs.find(p => p.isPrimary) || sortedProcs[0]
  return `## 복합 치료 케이스 구조 (${sortedProcs.length}단계)

### 주 치료: ${primaryProc.name}${primaryProc.toothNumber ? ` (${primaryProc.toothNumber})` : ''}
${primaryProc.details}
${primaryProc.emphasis ? `핵심 포인트: ${primaryProc.emphasis}` : ''}

### 치료 순서 (이 순서대로 서술하세요):
${sortedProcs.map((p, i) => `${i + 1}. ${p.name}${p.toothNumber ? ` (${p.toothNumber})` : ''}${p.isPrimary ? ' [주 치료]' : ' [보조]'}
   - ${p.details}${p.emphasis ? `\n   - 강조: ${p.emphasis}` : ''}`).join('\n')}

### 복합 케이스 서술 규칙 (중요!):
- 주 치료(${primaryProc.name})가 본론의 40% 이상을 차지해야 합니다.
- 보조 치료는 주 치료의 성공을 위해 왜 필요한지 맥락으로 설명하세요.
- 단계 간 전환 시 "이를 위해", "이 과정이 선행된 후", "~를 확인한 결과" 등 인과 연결어를 사용하세요.
- 각 단계를 독립적으로 나열하지 말고, 하나의 치료 여정으로 엮어 서술하세요.
- 전체 치료 계획을 서론에서 개요로 제시하고, 본론에서 단계별 상세 전개하세요.
`
})() : `## CC 활용 규칙
CC는 글의 **핵심 소재**입니다. 임상 내용을 적극 활용하되, "이런 경우" 형태로 일반화하세요.
(환자 정보 금지 규칙은 시스템 프롬프트 참조)`}

${ragContext !== '[기존 글 DB 참조 불가]' && ragContext !== '[참조 가능한 기존 글 없음]' ? `
## 🎭 이 치과의 기존 글 패턴 (스타일 반드시 반영!)
${ragContext}
` : ''}

## 키워드 전략 — 형태소 분리 규칙 (매우 중요!)

### 🎯 메인키워드: "${mainKeyword}" (형태소 분리 가능!)
메인키워드는 2개의 형태소로 구성됩니다. 각각 독립적으로 5~8회 자연스럽게 배치하세요!

- **형태소A**: "${data.region}" — 5~8회 (제목·서론·본론·마무리에 자연스럽게 분산)
- **형태소B**: "${mainKeyword.replace(data.region, '').trim() || '치과'}" — 5~8회 (제목·서론·본론·마무리에 자연스럽게 분산)

🚨 주의: 서론·마무리에만 넣고 본론에서 빠뜨리는 실수가 잦습니다!
본론 ## 섹션마다 형태소A 또는 형태소B를 최소 1회 이상 포함하세요!
⚠️ 키워드를 억지로 넣기보다 문맥에 자연스럽게 녹여 넣으세요. 독자가 삽입된 느낌을 받으면 실패입니다.

⚠️ 배치 규칙:
- **제목**: A+B 합쳐서 1회 (예: "${mainKeyword}")
- **서론**: A+B 합쳐서 1회 (예: "${data.region} ${mainKeyword.replace(data.region, '').trim() || '치과'}")
- **본론 (4회씩!)**: 각 ## 섹션에서 A, B를 합쳐서 또는 따로 사용!
  ✅ "${data.region}에서는 이런 증상을..." (A만)
  ✅ "${mainKeyword.replace(data.region, '').trim() || '치과'}에서 정밀 진단을..." (B만)
  ✅ "${mainKeyword}에서 알려드리는..." (A+B 합쳐서)
  ✅ "${data.region} 지역에서도..." (A만, 자연스러운 문맥)
- **마무리**: A+B 합쳐서 1회
- ❌ 한 문단에 동일 형태소 2회 이상 금지!
- ✅ 본론이 ## 섹션 2~3개라면, 각 섹션에 A 1~2회 + B 1~2회 분산

${(data.topic && !mainKeyword.includes(data.topic)) ? `### 치료 서브키워드: "${data.topic}"
- 형태소B와 별도로 3~5회 자연스럽게 배치 (초반200자, 중간, 마지막200자 포함)` : `### 치료 키워드: "${data.topic}"
- ⚠️ 형태소B와 동일한 단어! 위 형태소B 7회 규칙이 곧 "${data.topic}" 배치 규칙입니다.
- "${data.topic}"을 추가로 단독 반복하지 마세요 — 형태소B 7회에 이미 포함됨!`}
- 서브 키워드: ${keywordsToUse.join(', ')} (각 2회)
${selectedKeywords && selectedKeywords.length > 0 ? `- ⭐ 사용자 선택 키워드 (우선 반영): ${selectedKeywords.join(', ')}` : ''}

${getSynonymInstruction()}

### SEO 키워드 조합 (제목, 서문, 마무리에만 사용)
- "${data.region} ${data.clinicName}" 형태로 2~3회 배치
- 이번 달 인기 키워드: ${popularKeywords.join(', ')}
- 추천 해시태그: ${hashtags.join(' ')}

## 시즌 훅 (서문에 자연스럽게 활용)
"${seasonHook}"

${diversityDirective || ''}

${trendAnalysis && trendAnalysis !== '[키워드 트렌드 분석 불가]' ? `
${trendAnalysis}
` : ''}

${imageSection}

${imageNames.length === 0 && data.writingMode === 'informative' ? generateImageHints(data.topic) : ''}

${formatMedicalInfoForPrompt(data.topic)}

## 공통 생성 규칙
- 공백 제외 글자수는 2,000자 이상을 유지하세요. 부족하면 반복을 늘리기보다 사실 기반 맥락을 보강해 분량을 채워주세요.
- Q&A/FAQ는 중간에 넣지 마세요. 본문 중간의 뜬금포 Q&A/FAQ는 금지입니다.
- Q&A/FAQ는 **마무리(결론)에서만 마지막 정리용으로 1개 이하** 사용합니다.
- 임상 모드에서는 기본적으로 Q&A/FAQ를 사용하지 않으며, 꼭 필요할 때만 마무리에서 1개 이하로 반영하세요.
- 정보성 모드에서는 비유 표현을 문단마다 반복하지 말고 전체 1~2회 이내로 제한하세요.
- "충분히 ~할 수 있습니다", "알아보기 쉽습니다" 같은 상투적 멘트가 반복되지 않도록 주의하세요.
- 어떤 단어든 **공백/구두점 제거 기준으로 6회 이상 반복**되지 않게 작성하세요.
- 단, 형태소A/B(지역명/메인키워드) 배치 규칙은 기존 지침 우선 적용으로, 그 외 단어는 상한을 엄수하세요.

## 📝 글쓰기 규칙 (필수 준수!)

${data.writingMode === 'informative' ? `### ⚠️ 글자수 (공백 제외 기준!)
- **1막 도입**: 400자 이상 (공감 훅 + 궁금증 유발)
- **2막 원인**: 상한 없음! 비유와 함께 충분히 설명!
- **3막 해결**: 상한 없음! 이야기식 서술 중심으로 마무리로 자연스럽게 연결하세요.
- **4막 마무리**: 300자 이상 (요약 + 행동 유도)
- **최소**: 2,000자 이상 (공백 제외)
- 해시태그: 별도 10개 (글자수 미포함)

✅ 글자수 상한은 없습니다! 내용이 풍부할수록 좋습니다!
✅ 각 막 사이에 궁금증 루프("그렇다면 ~는 어떨까요?")를 삽입하세요!
✅ 본론이 길어지는 것은 자연스럽습니다 — 절대 내용을 줄이지 마세요!

### 📚 정보성 4막 구조 (필수!)
- **1막 도입**: 공감 훅 + 궁금증 유발 → "혹시 ~하신 적 있으신가요?"
- **2막 원인**: 왜 이런 일이 생기는지 비유와 함께 설명 → "마치 ~과 같은 원리이죠."
- **3막 해결**: 치료법을 이야기식으로 전개하고, Q&A/FAQ 정리는 4막 마무리에서 1개 이하로만 정리하세요.
- **4막 마무리**: 핵심 요약 + 안심 + 행동 유도

🎣 막 사이마다 궁금증 루프 삽입!
"그렇다면 ~는 어떨까요?" / "여기서 한 가지 더 알아둘 점이 있습니다."

⚠️ 번호 목록/단계 금지! 이야기하듯 서술!
⚠️ "~에 대해 알아보겠습니다" 같은 AI 상투어 금지!

### 🎯 AEO/GEO 체크리스트 (정보성 모드 필수!)
- [ ] 매 ## 소제목 아래 첫 문장이 40~60자 핵심 답변인가?
- [ ] Q&A/FAQ를 중간 본문이 아닌 **4막 마무리에서만 1개 이하**로 사용했는가?
- [ ] 비유/비교 표현이 문단 반복이 아닌, 전체 1~2회 이내로 제한했는가?
- [ ] 150~200자마다 수치/통계가 포함되어 있는가?
- [ ] 전문 용어마다 "X란 Y입니다" 정의 문장이 있는가?
- [ ] 각 ## 섹션이 독립적으로 추출 가능한가? (상호참조 최소화)
- [ ] 문단이 4문장(120자) 이내인가?` : `### ⚠️ 글자수 (공백 제외 기준!)
- **서론**: 500자 이상 (공백 제외)
- **본론**: 상한 없음! 이미지마다 3단계(판독→의미→맥락) 서술로 충분히 작성!
- **결론**: 400자 이상 (공백 제외)
- **최소**: 2,000자 이상 (공백 제외)
- 해시태그: 별도 10개 (글자수 미포함)

✅ 글자수 상한은 없습니다! 내용이 풍부할수록 좋습니다!
✅ 각 이미지/소견마다 판독→임상적 의미→맥락 부연을 충분히 서술하세요!
✅ 본론이 길어지는 것은 자연스럽습니다 — 절대 내용을 줄이지 마세요!`}

${data.customSections && data.customSections.length > 0 ? `### 📋 본론 구조 (소제목 지정됨 — 반드시 이 제목 사용!)
${data.customSections.map((s, i) => `섹션 ${i + 1}: ## ${s.title}${s.description ? `\n  - ${s.description}` : ''}`).join('\n')}

⚠️ 위 소제목을 정확히 그대로 사용하세요. 변형/추가 금지.
각 섹션에 400자 이상 작성하세요.` : ''}

### 🚨 형태소 배치 확인 (자가 검증 — 반드시 수행!)
글 작성 완료 후, 아래 체크리스트를 하나씩 확인하세요:
- [ ] 형태소A "${data.region}" 5~8회 범위인가?
- [ ] 형태소B "${mainKeyword.replace(data.region, '').trim() || '치과'}" 5~8회 범위인가?
- [ ] 제목, 첫 200자, 마지막 200자에 각 1회 이상 포함인가?
- [ ] 본론 각 ## 섹션에 형태소가 최소 1회 이상 등장하는가?
- [ ] 키워드가 문맥에 자연스럽게 녹아 있는가? (기계적 삽입 문장 없는가?)
- [ ] 한 문단에 동일 형태소 2회 이상 없는가?
⚠️ "치료", "진행", "확인", "상태" 등 일반 단어는 한 섹션(##) 내 3회 이상 반복 금지! 반드시 동의어로 교체!

### 문장/문단 규칙 (모바일 최적화!)
1. **한 문단**: 2~3줄, 60~100자 (3줄 초과 금지!)
2. **한 문장**: 30~40자 이내 (모바일에서 2줄 넘어가면 줄바꿈)
3. **문단 사이**: 반드시 빈 줄(엔터 2회) 삽입 → 모바일 가독성
4. **소제목**: 300~400자마다 ##(H2) 소제목 삽입
5. **이모지**: 소제목에만 (✅🔹💚), 본문 중간에는 자제
6. **불릿 리스트**: 나열형 정보는 반드시 불릿(- 또는 ✅🔹💚) 형태
7. **어미**: 위 "글쓰기 모드" 어미 규칙 준수!
8. **"됩니다" 주의**: "해야 됩니다" → "해야 합니다", "되야" → "되어야"

### 🔄 중복 단어 방지 (유의어 순환)
- 형태소A/B: 각 5~8회 범위 (위 배치 규칙 참조)
- 일반 명사 (치료, 진행, 확인, 상태 등): 최대 5회, 초과 시 동의어 교체
- 강조 부사 ("무엇보다", "가장", "특히"): 글 전체 최대 2회
- 한 문단 내 같은 단어 2회 이상 금지

**유의어 순환 사전:**
치료↔시술↔처치↔진료 / 증상↔양상↔소견↔징후 / 관찰↔확인↔발견↔식별
진행↔시행↔수행↔실시 / 경우↔상황↔케이스↔사례 / 상태↔양상↔정도↔현황
통증↔부담감↔동통↔압통 / 부위↔영역↔부분↔해당 위치

### CC/치료 정보 반영 규칙 (⚠️ 글의 핵심!)
CC가 곧 글의 뼈대입니다. 본론의 50% 이상이 CC 내용에서 나와야 합니다:
- CC에 언급된 증상/상태 → 서론의 공감 훅 + 본론의 소견 서술 소재
- CC에 언급된 치료법/단계 → 본론의 치료 과정을 순서대로 상세 전개
- CC에 치식번호(#26 등), 강조포인트 → 본론에서 핵심적으로 다루기
- ✅ "이런 증상으로 내원하시는 분들이 많습니다" → CC 내용을 녹여서 작성
- ❌ 단, 특정 환자 직접 언급은 금지! "이런 경우" 형태로 일반화
${data.patientInfo && data.patientInfo.includes('🔬 핵심 팩트') ? `
### 📚 리서치 CC 활용 규칙 (정보성 모드 강화!)
CC에 리서치 데이터(핵심 팩트, 흔한 오해, FAQ, 논문)가 포함되어 있습니다.
이 데이터를 글 전체에 **풍부하게** 녹여서 작성하세요:
- 🔬 핵심 팩트 → 본론 각 섹션에 **구체적 수치/통계**로 인용 (예: "~로 보고되고 있습니다")
- 🤔 흔한 오해 → "오해 반전" 구조로 독자의 궁금증 해소 (예: "~라고 알려져 있지만, 사실은~")
- ❓ FAQ/오해 포인트는 문장 속으로 녹여 쓰고, 필요한 핵심 정리는 4막 마무리 1개 이하로 정리
- 📎 논문 → 신뢰도 높은 근거로 자연스럽게 인용 ("~에 따르면", "(출처: ~)")
- 리서치 내용만으로도 충분히 풍부한 글 작성 가능 (RAG/페르소나 없이도 OK)
- 단, 리서치 내용을 그대로 나열하지 말고, **독자 친화적 스토리**로 재구성하세요
` : ''}

### 🏥 의료광고법 6원칙 (절대 준수!)
1. **최상급 표현 금지**: 최고→숙련된, 유일→OOO에 집중하는, 최첨단→정밀한, 제일→전문적인
2. **후기 형식 금지**: 환자 후기/체험담 금지 → 정보 전달/증례 소개 형식으로 작성
3. **전후 사진 3원칙**: 동일 조건 촬영, 부작용 고지 병기, 혐오감 유발 이미지 주의
4. **통증/부작용 단정 금지**: 무통→저통증, 부작용 없음→금지, 아프지 않→통증이 적
5. **전문 용어 사용**: 크라운→지르코니아 보철, 때우기→수복, 이빨→치아, 씌우기→보철
6. **환자 유인/알선 금지**: 무료, 할인, 상품권, 이벤트, 가성비 표현 절대 금지
7. **효과 보장/성공률 금지**: "치료 성공률 90%", "완치", "좋은 결과" → "예후가 양호한 것으로 보고", "적절한 관리가 가능"

### 🚫🚫🚫 금칙어 — 아래 단어는 글 어디에도 쓰면 안됩니다!! 🚫🚫🚫
| 금칙어 | 대체어 | 예시 |
|--------|--------|------|
| 걱정 | 염려, 우려 | "걱정 마세요" ❌ → "염려하지 않으셔도 됩니다" ✅ |
| 경험 | 겪다, 접하다 | "경험하게 됩니다" ❌ → "겪게 됩니다" ✅ |
| 고민 | 궁금증, 고충 | "고민거리" ❌ → "궁금증" ✅ |
| 고통 | 통증, 아픔 | |
| 너무 | 매우, 상당히, 지나치게 | "너무 오래" ❌ → "지나치게 오래" ✅ |
| 힘들 | 어렵다, 힘겹다 | "소변보기 힘들고" ❌ → "소변이 잘 나오지 않고" ✅ |
| 불편 | 부담, 어려움, 이상 | "불편함을 느끼게" ❌ → "이상을 느끼게" ✅ |
| 불안 | 마음이 편치 않은 | |
| 만족 | 흡족 | |
| 해결 | 개선, 처리, 극복 | |
| 해소 | 완화, 줄이다 | |
⚠️ 제목에도 금칙어를 쓰면 안됩니다! "힘들고" ❌ → "잘 나오지 않고" ✅

### 📋 수치/성공률/효과 보장 금지
- ❌ "성공률 80%", "90% 이상", "완치율" 등 구체적 수치 절대 사용 금지!
- ❌ "약 50%", "절반 이상" 등 통계적 수치 인용 금지 (의료법 위반 소지)
- ❌ "좋은 결과", "충분한 개선 효과", "완치" 표현 금지
- ✅ "적절한 관리를 통해 개선을 기대할 수 있습니다" 형태로 작성

### 📋 제목/병원명/마무리 규칙
- **제목**: 궁금증/고민 형태 (예: "혈뇨가 나왔는데, 전립선암일까요?"), 20~30자
  - ❌ 제목에 병원명 넣지 마세요!
  - ❌ "~에서 알려드립니다" 형태 금지
- **병원명 사용 위치**: 서문 인사 + 마무리 인사에서만!
  - ❌ 본문 중간에 "~에서 진료하면서", "~지역에서도 좋은 결과" 등 금지
- **마무리 인사**: "[지역] [병원명] [이름]이었습니다." ← 여기서 끝!
  - ❌ "감사합니다" 추가 금지

### 필수 포함 항목
- Q&A 블록 (스마트블록용, 4막 마무리에서만 1개 이하)
- 부작용 고지문
- 해시태그 10개 (중복 없이)
${imageNames.length > 0 ? '- 이미지 플레이스홀더 ([IMAGE_1], [IMAGE_2])' : ''}
${paperCitations && paperCitations.length > 0 ? `
### 📎 논문 인용 지시 (PubMed 검색 결과)
아래 실존 논문을 본문에서 자연스럽게 인용하세요.

${paperCitations.map((p, i) => `[${i + 1}] ${p.authors}. "${p.title}." ${p.journal}, ${p.year}.${p.doi ? ` DOI: ${p.doi}` : ''}
   요약: ${p.abstract || '(초록 없음)'}`).join('\n\n')}

**인용 규칙:**
- 본문에서 관련 내용 서술 시 [1], [2] 형태로 번호 인용
- 또는 "Kim et al.(2023)에 따르면..." 형태로 저자명 인용
- 글 끝(부작용 고지 앞)에 📎 References 섹션 생성
- References 형식: [1] 저자명. "논문 제목." 저널명, 연도.${paperCitations.some(p => p.doi) ? ' DOI: xxx' : ''}
- 최소 2건 이상 인용 (전부 사용하지 않아도 됨)
- ※ References 섹션은 글자수에 포함되지 않습니다
` : ''}
글 작성을 시작해주세요.`
}

// ============================================================
// LLM 스트리밍 함수 (비용 최적화 옵션 포함)
// ============================================================

// Claude API 스트리밍 (Sonnet 4 사용)
async function* streamClaude(systemPrompt: string, userPrompt: string, useHaiku: boolean = false) {
  // 2026년 2월 기준: claude-sonnet-4-20250514 (고품질 + 긴 글 작성)
  // useHaiku 옵션과 상관없이 Sonnet 4 사용 (Haiku 모델 접근 불가)
  const modelId = 'claude-sonnet-4-20250514'
  console.log(`[LLM] Using Claude model: ${modelId}`)

  const response = await anthropic.messages.create({
    model: modelId,
    max_tokens: 8192,  // Sonnet 4는 8192 지원
    system: systemPrompt,
    messages: [{ role: 'user', content: userPrompt }],
    stream: true,
  })

  for await (const event of response) {
    if (event.type === 'content_block_delta' && event.delta.type === 'text_delta') {
      yield event.delta.text
    }
  }
}

// OpenAI API 스트리밍 (GPT-4o / GPT-4o-mini 선택)
async function* streamOpenAI(systemPrompt: string, userPrompt: string, useMini: boolean = false) {
  // 💰 GPT-4o-mini = 빠름 + 저비용 (~15배 저렴), GPT-4o = 고품질
  // 2026년 1월 기준 사용 가능한 모델
  const modelId = useMini ? 'gpt-4o-mini-2024-07-18' : 'gpt-4o-2024-11-20'
  console.log(`[LLM] Using OpenAI model: ${modelId}`)

  const response = await openai.chat.completions.create({
    model: modelId,
    max_tokens: 4096,
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt },
    ],
    stream: true,
  })

  for await (const chunk of response) {
    const text = chunk.choices[0]?.delta?.content
    if (text) {
      yield text
    }
  }
}

// Gemini API 스트리밍 (무료 할당량 내 사용 가능)
async function* streamGemini(systemPrompt: string, userPrompt: string) {
  // 2026년 1월 기준: gemini-2.0-flash (빠름 + 무료)
  console.log(`[LLM] Using Gemini model: gemini-2.0-flash`)

  const model = genAI.getGenerativeModel({
    model: 'gemini-2.0-flash',
    systemInstruction: systemPrompt,
  })

  const result = await model.generateContentStream(userPrompt)

  for await (const chunk of result.stream) {
    const text = chunk.text()
    if (text) {
      yield text
    }
  }
}

// 모델별 스트리밍 선택 (저비용 옵션 지원)
function getStreamGenerator(model: LLMModel, systemPrompt: string, userPrompt: string) {
  switch (model) {
    case 'claude-haiku':
      return streamClaude(systemPrompt, userPrompt, true) // 💰 저비용
    case 'claude':
      return streamClaude(systemPrompt, userPrompt, false)
    case 'openai-mini':
      return streamOpenAI(systemPrompt, userPrompt, true) // 💰 저비용
    case 'openai':
      return streamOpenAI(systemPrompt, userPrompt, false)
    case 'gemini':
      return streamGemini(systemPrompt, userPrompt)
    default:
      return streamClaude(systemPrompt, userPrompt, true) // 기본값 = 저비용
  }
}

export async function POST(request: NextRequest) {
  try {
    const rawData: GenerateFormData = await request.json()

    // 🛡️ URL 및 링크 제거 (사용자 입력에서 URL이 포함된 경우 필터링)
    const data = sanitizeFormData(rawData)

    // API 키 확인 (저비용 모델 포함)
    const model = data.model || 'claude-haiku' // 기본값 = 저비용 모델
    const needsAnthropicKey = model === 'claude' || model === 'claude-haiku'
    const needsOpenAIKey = model === 'openai' || model === 'openai-mini'

    if (needsAnthropicKey && !process.env.ANTHROPIC_API_KEY) {
      return new Response(JSON.stringify({ error: 'Claude API 키가 설정되지 않았습니다.' }), { status: 400 })
    }
    if (needsOpenAIKey && !process.env.OPENAI_API_KEY) {
      return new Response(JSON.stringify({ error: 'OpenAI API 키가 설정되지 않았습니다.' }), { status: 400 })
    }
    if (model === 'gemini' && !process.env.GEMINI_API_KEY) {
      return new Response(JSON.stringify({ error: 'Gemini API 키가 설정되지 않았습니다.' }), { status: 400 })
    }

    // ============================================================
    // 🚀 최적화: 동기 작업 먼저 처리 (0ms)
    // ============================================================
    const seasonHook = data.diversityHints
      ? getSeasonHookByIndex(data.topic, data.diversityHints.seasonHookIndex)
      : getSeasonHook(data.topic)
    // 메인키워드: 사용자 직접 입력 우선 → 없으면 자동 생성
    const mainKeyword = data.mainKeyword?.trim() || generateMainKeyword(data.region, data.topic)
    const subKeywords = suggestSubKeywords(data.topic)
    const popularKeywords = getMonthlyPopularKeywords()

    // ============================================================
    // 🚀 최적화: 비동기 API 호출 병렬 처리 (기존 순차 3-4초 → 병렬 1-2초)
    // ============================================================
    const [ragResult, keywordResult, personaResult] = await Promise.allSettled([
      // RAG 컨텍스트 생성: sourceClinic이 있으면 해당 치과 글 우선 참조, 없으면 clinicName 참조
      generateRAGContext(data.topic, data.sourceClinic || data.clinicName || undefined),
      analyzeKeywordsComprehensive(data.topic),
      // 치과별 페르소나 추출 (usePersona가 true이거나 기본적으로 항상 시도)
      data.clinicName ? extractClinicPersona(data.clinicName, data.topic) : Promise.resolve(null),
    ])

    // RAG 결과 처리
    const ragContext = ragResult.status === 'fulfilled'
      ? ragResult.value
      : '[기존 글 DB 참조 불가]'

    // 치과별 페르소나 처리
    let clinicPersona: ClinicPersona | null = null
    if (personaResult.status === 'fulfilled' && personaResult.value) {
      clinicPersona = personaResult.value
      console.log(`[Persona] ${data.clinicName}의 "${data.topic}" 스타일 발견 (${clinicPersona.postCount}개 글 분석)`)
    } else {
      console.log(`[Persona] ${data.clinicName}의 기존 글 없음 - 기본 스타일 사용`)
    }

    // 키워드 분석 결과 처리
    let keywordAnalysis: KeywordAnalysisResult | null = null
    let trendAnalysis = ''

    if (keywordResult.status === 'fulfilled') {
      keywordAnalysis = keywordResult.value
      trendAnalysis = keywordAnalysis.searchTrend.analysis

      if (keywordAnalysis.searchTrend.topKeyword) {
        trendAnalysis += `\n\n### 🏆 1위 인기 키워드\n`
        trendAnalysis += `**"${keywordAnalysis.searchTrend.topKeyword}"** `
        trendAnalysis += keywordAnalysis.searchTrend.direction === 'up' ? '(📈 상승 중)' :
          keywordAnalysis.searchTrend.direction === 'down' ? '(📉 하락 중)' : '(➡️ 안정적)'
        trendAnalysis += `\n\n**SEO 점수:** ${keywordAnalysis.seoScore}/100\n`
      }

      if (keywordAnalysis.recommendations.length > 0) {
        trendAnalysis += `\n### 💡 키워드 전략 추천\n`
        trendAnalysis += keywordAnalysis.recommendations.join('\n')
      }

      // 쇼핑 인사이트 추가 (해당되는 경우)
      if (keywordAnalysis.shoppingTrend.available) {
        trendAnalysis += `\n\n### 🛒 쇼핑 인사이트\n${keywordAnalysis.shoppingTrend.analysis}`
      }
    } else {
      // Promise.allSettled에서 rejected된 경우
      console.error('Keyword analysis error:', keywordResult.status === 'rejected' ? keywordResult.reason : 'unknown')
      trendAnalysis = '[키워드 트렌드 분석 불가]'
    }

    // 해시태그 미리 생성
    const hashtags = generateHashtags(mainKeyword, subKeywords, data.region, data.topic)

    // 이미지 파일명 추출
    const imageNames = data.images?.map(img => img.name) || []

    // 논문 검색 (citePapers 활성 시)
    let paperCitations: PaperCitation[] = []
    if (data.citePapers) {
      try {
        paperCitations = await searchPubMed(data.topic, 5)
        console.log(`[Papers] Found ${paperCitations.length} papers for "${data.topic}"`)
      } catch (error) {
        console.error('[Papers] PubMed search failed:', error)
        // Non-fatal: 논문 없이 계속 진행
      }
    }

    // 프롬프트 빌드 (치과별 페르소나 + 글쓰기 모드 적용)
    const systemPrompt = buildSystemPrompt(data.topic, clinicPersona, data.writingMode)
    // 배치 다양성 지시 생성
    const diversityDirective = data.diversityHints
      ? buildDiversityDirective(data.diversityHints)
      : ''

    const userPrompt = buildUserPrompt(
      data, mainKeyword, subKeywords, hashtags, seasonHook,
      ragContext, trendAnalysis, popularKeywords, imageNames,
      data.selectedKeywords, // 사용자 선택 키워드
      diversityDirective,    // 배치 다양성 지시
      paperCitations         // 논문 인용 데이터
    )

    // 스트리밍 응답 생성
    const encoder = new TextEncoder()
    const stream = new ReadableStream({
      async start(controller) {
        try {
          let fullContent = ''

          // 모델 정보 전송
          controller.enqueue(
            encoder.encode(`data: ${JSON.stringify({ type: 'model', model })}\n\n`)
          )

          const generator = getStreamGenerator(model, systemPrompt, userPrompt)

          for await (const text of generator) {
            fullContent += text
            controller.enqueue(
              encoder.encode(`data: ${JSON.stringify({ type: 'content', text })}\n\n`)
            )
          }

          // 메타데이터 파싱
          const metadataMatch = fullContent.match(
            /---METADATA_START---\s*([\s\S]*?)\s*---METADATA_END---/
          )
          const contentMatch = fullContent.match(
            /---CONTENT_START---\s*([\s\S]*?)\s*---CONTENT_END---/
          )

          let metadata = {
            title: '',
            mainKeyword: mainKeyword,
            subKeywords: subKeywords,
            hashtags: hashtags,
            charCount: 0,
          }

          if (metadataMatch) {
            try {
              const parsed = JSON.parse(metadataMatch[1])
              metadata = { ...metadata, ...parsed }
            } catch {
              // 파싱 실패 시 기본값 사용
            }
          }

          const rawContent = contentMatch ? contentMatch[1].trim() : fullContent
          // 금칙어·의료법·키워드빈도·동의어회전 후처리
          const processed = postProcess(rawContent, {
            topic: data.topic || '',
            mainKeyword: mainKeyword,
            clinicName: data.clinicName || '',
            region: data.region || '',
            writingMode: data.writingMode,
          })
          // 44byte 줄바꿈 후처리 (네이버 블로그 최적화)
          const content = formatLineBreaks(processed)
          // 해시태그 제외, 공백 제외 글자수 계산
          metadata.charCount = countContentChars(content)

          // 의료법 금지어 검증
          const forbiddenViolations = checkForbiddenPatterns(content)
          const warnings: string[] = []

          if (forbiddenViolations.length > 0) {
            console.warn(`[Warning] 의료법 위반 표현 발견: ${forbiddenViolations.map(v => v.match).join(', ')}`)
            warnings.push(`⚠️ 의료법 위반 가능 표현: ${forbiddenViolations.map(v => `"${v.match}" (${v.reason})`).join(', ')}`)
          }

          // ~요 어미 검증 (금지 어미 사후 검사)
          const forbiddenEndings = ['해요', '거든요', '있어요', '드려요', '할게요', '볼게요', '줄게요']
          const foundEndings: string[] = []
          for (const ending of forbiddenEndings) {
            const regex = new RegExp(ending, 'g')
            const matches = content.match(regex)
            if (matches && matches.length > 0) {
              foundEndings.push(`${ending}(${matches.length}회)`)
            }
          }
          if (foundEndings.length > 0) {
            console.warn(`[Warning] 금지 어미 ~요 발견: ${foundEndings.join(', ')}`)
            warnings.push(`🚫 금지 어미(~요) 발견: ${foundEndings.join(', ')} — 수정이 필요합니다`)
          }

          // 글자수 경고 (최소 기준만 적용, 상한 없음)
          if (metadata.charCount < 2000) {
            warnings.push(`⚠️ 글자수 부족: ${metadata.charCount}자 (최소 2,000자 이상 필요)`)
          }

          // RAG/페르소나 상태 정보
          const ragInfo = {
            personaApplied: !!clinicPersona,
            personaPostCount: clinicPersona?.postCount || 0,
            personaAvgLength: clinicPersona?.avgLength || 0,
            ragAvailable: ragContext !== '[기존 글 DB 참조 불가]' && ragContext !== '[참조 가능한 기존 글 없음]',
          }

          // 최종 결과 전송
          controller.enqueue(
            encoder.encode(
              `data: ${JSON.stringify({
                type: 'result',
                data: {
                  title: metadata.title,
                  content,
                  keywords: {
                    main: metadata.mainKeyword,
                    sub: metadata.subKeywords,
                  },
                  hashtags: metadata.hashtags,
                  charCount: metadata.charCount,
                  model: model,
                  references: paperCitations.length > 0 ? paperCitations : undefined,
                  warnings: warnings.length > 0 ? warnings : undefined,
                  ragInfo,
                },
              })}\n\n`
            )
          )

          controller.enqueue(encoder.encode('data: [DONE]\n\n'))
          controller.close()
        } catch (error) {
          console.error('Stream error:', error)
          controller.error(error)
        }
      },
    })

    return new Response(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        Connection: 'keep-alive',
      },
    })
  } catch (error) {
    console.error('Generate API error:', error)
    return new Response(
      JSON.stringify({ error: '글 생성에 실패했습니다.' }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    )
  }
}
